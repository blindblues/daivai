---
import "../styles/global.css";
import NavbarAuth from "../components/ui/NavbarAuth.astro";
import ProfileForm from "../components/features/ProfileForm.astro";
import DocumentUpload from "../components/features/DocumentUpload.astro";

// Note: Authentication is checked client-side since Supabase uses localStorage
---

<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Il tuo profilo personale - Dai Vai" />
        <title>Profilo | Dai Vai</title>

        <!-- Favicon -->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/daivai/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/daivai/favicon/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/daivai/favicon/favicon-16x16.png"
        />
        <link rel="manifest" href="/daivai/favicon/site.webmanifest" />
        <link rel="shortcut icon" href="/daivai/favicon/favicon.ico" />

        <!-- Favicon SVG -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="/daivai/images/DaiVai.svg"
        />

        <!-- Font preload -->
        <link
            rel="preload"
            href="/daivai/fonts/condenso/Condenso-Regular.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />

        <!-- Theme color -->
        <meta name="theme-color" content="#FB6068" />

        <!-- Cropper.js CSS -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css"
        />
    </head>

    <body>
        <NavbarAuth />

        <main class="profile-page">
            <!-- Loading State -->
            <div id="loading-profile" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Caricamento profilo...</p>
            </div>

            <!-- Profile Content (hidden until loaded) -->
            <div
                id="profile-container"
                class="profile-container"
                style="display: none;"
            >
                <!-- Hero Header -->
                <section class="profile-hero">
                    <div class="profile-avatar" id="profile-avatar">
                        <span id="avatar-initials">?</span>
                        <div class="avatar-overlay">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                                ></path><circle cx="12" cy="13" r="4"
                                ></circle></svg
                            >
                        </div>
                    </div>
                    <input
                        type="file"
                        id="avatar-input"
                        accept="image/*"
                        style="display: none;"
                    />
                    <h2 class="profile-user-name" id="profile-user-name">
                        Caricamento...
                    </h2>
                    <p class="profile-user-email" id="profile-user-email"></p>
                    <div
                        id="admin-badge"
                        class="admin-badge"
                        style="display: none;"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path
                                d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
                            ></path></svg
                        >
                        Admin
                    </div>
                </section>

                <!-- Personal Data Section -->
                <section class="profile-card" id="card-personal">
                    <div class="profile-content" id="profile-content">
                        <!-- ProfileForm will be inserted here by JS -->
                    </div>
                </section>

                <!-- Action Bar -->
                <section class="profile-action-bar" id="card-actions">
                    <a
                        href="/daivai/admin"
                        id="admin-link"
                        class="btn-action btn-admin-panel"
                        style="display: none;"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><rect x="3" y="3" width="7" height="7"></rect><rect
                                x="14"
                                y="3"
                                width="7"
                                height="7"></rect><rect
                                x="14"
                                y="14"
                                width="7"
                                height="7"></rect><rect
                                x="3"
                                y="14"
                                width="7"
                                height="7"></rect></svg
                        >
                        Admin
                    </a>
                    <button id="logout-btn" class="btn-action btn-logout">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2 2h4"
                            ></path><polyline points="16 17 21 12 16 7"
                            ></polyline><line x1="21" y1="12" x2="9" y2="12"
                            ></line></svg
                        >
                        Esci
                    </button>
                    <button
                        id="delete-account-btn"
                        class="btn-action btn-delete-profile"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M3 6h18"></path><path
                                d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
                            ></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
                            ></path></svg
                        >
                        Elimina Profilo
                    </button>
                </section>

                <!-- Delete Confirmation Modal -->
                <div
                    id="delete-modal"
                    class="modal-overlay"
                    style="display: none;"
                >
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Elimina Profilo</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>
                                Sei sicuro di voler eliminare il tuo profilo?
                                Questa azione cancellerà tutti i tuoi dati e
                                documenti. <strong
                                    >Non potrai tornare indietro.</strong
                                >
                            </p>
                            <div class="confirmation-input">
                                <label for="confirm-text"
                                    >Digita <strong>Conferma</strong> per procedere:</label
                                >
                                <input
                                    type="text"
                                    id="confirm-text"
                                    placeholder="Conferma"
                                    autocomplete="off"
                                />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-cancel-modal">Annulla</button>
                            <button
                                id="confirm-delete-btn"
                                class="btn-delete-confirm"
                                disabled>Elimina Definitivamente</button
                            >
                        </div>
                    </div>
                </div>

                <!-- Cropping Modal -->
                <div
                    id="cropper-modal"
                    class="modal-overlay"
                    style="display: none;"
                >
                    <div class="modal-content cropper-container">
                        <div class="modal-header">
                            <h3>Ritaglia Foto</h3>
                            <button class="close-cropper">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="img-container">
                                <img id="cropper-image" src="" alt="To crop" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-cancel-cropper btn-action"
                                >Annulla</button
                            >
                            <button
                                id="save-cropped-btn"
                                class="btn-submit active">Salva</button
                            >
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            import { supabase } from "@/lib/client";
            import { getCurrentUserProfile } from "@/lib/database/profiles";

            async function loadProfile() {
                const loadingEl = document.getElementById("loading-profile");
                const containerEl =
                    document.getElementById("profile-container");
                const contentEl = document.getElementById("profile-content");
                const adminBadge = document.getElementById("admin-badge");
                const adminLink = document.getElementById("admin-link");
                const avatarInitials =
                    document.getElementById("avatar-initials");
                const userName = document.getElementById("profile-user-name");
                const userEmail = document.getElementById("profile-user-email");

                try {
                    // Check for mock mode
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const isMockMode = urlParams.get("mock") === "true";

                    let user, profile;

                    if (isMockMode) {
                        console.log("Profile: Running in Mock Mode");
                        user = { email: "mario.rossi@esempio.it" };
                        profile = {
                            id: "mock-id",
                            email: "mario.rossi@esempio.it",
                            first_name: "Mario",
                            last_name: "Rossi",
                            birth_date: "1990-01-01",
                            phone: "+39 123 456 7890",
                            address: "Via Roma, 10",
                            city: "Verona",
                            postal_code: "37100",
                            role: "admin",
                            document_url: null,
                            avatar_url: null,
                        };
                    } else {
                        // Check authentication
                        const {
                            data: { user: authUser },
                        } = await supabase.auth.getUser();
                        user = authUser;

                        if (!user) {
                            window.location.href = "/daivai/login";
                            return;
                        }

                        // Get profile
                        const { data: userProfile, error } =
                            await getCurrentUserProfile();
                        profile = userProfile;

                        if (error || !profile) {
                            console.error("Profile error:", error);
                            window.location.href = "/daivai/login";
                            return;
                        }
                    }

                    // Set avatar initials or image
                    if (avatarInitials) {
                        if (profile.avatar_url) {
                            const avatarContainer =
                                document.getElementById("profile-avatar");
                            if (avatarContainer) {
                                avatarContainer.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar" />
                                    <div class="avatar-overlay">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                    </div>`;
                            }
                        } else {
                            const firstInit = (profile.first_name ||
                                "?")[0].toUpperCase();
                            const lastInit = (profile.last_name ||
                                "?")[0].toUpperCase();
                            avatarInitials.textContent = `${firstInit}${lastInit}`;
                        }
                    }

                    // Set user name and email
                    if (userName)
                        userName.textContent =
                            `${profile.first_name || ""} ${profile.last_name || ""}`.trim() ||
                            "Utente";
                    if (userEmail) userEmail.textContent = profile.email || "";

                    // Show admin badge if admin
                    if (profile.role === "admin") {
                        if (adminBadge)
                            adminBadge.style.display = "inline-flex";
                        if (adminLink) adminLink.style.display = "inline-flex";
                    }

                    // Render ProfileForm
                    const formHTML = `
                        <div class="form-section">
                            <div class="form-header">
                                <div class="form-header-left">
                                    <h3>Dati Personali</h3>
                                </div>
                            </div>
                            <form id="profile-form">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input type="email" id="email" value="${profile.email || ""}" readonly class="always-readonly" />
                                    </div>
                                    <div class="form-group">
                                        <label for="first_name">Nome</label>
                                        <input type="text" id="first_name" value="${profile.first_name || ""}" placeholder="Mario" class="editable-field" />
                                    </div>
                                    <div class="form-group">
                                        <label for="last_name">Cognome</label>
                                        <input type="text" id="last_name" value="${profile.last_name || ""}" placeholder="Rossi" class="editable-field" />
                                    </div>
                                    <div class="form-group">
                                        <label for="birth_date">Data di Nascita</label>
                                        <input type="date" id="birth_date" value="${profile.birth_date || ""}" class="editable-field" />
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">Telefono</label>
                                        <input type="tel" id="phone" value="${profile.phone || ""}" placeholder="+39 123 456 7890" class="editable-field" />
                                    </div>
                                    <div class="form-group full-width">
                                        <label for="address">Indirizzo</label>
                                        <input type="text" id="address" value="${profile.address || ""}" placeholder="Via Roma, 10" class="editable-field" />
                                    </div>
                                    <div class="form-group">
                                        <label for="city">Città</label>
                                        <input type="text" id="city" value="${profile.city || ""}" placeholder="Verona" class="editable-field" />
                                    </div>
                                    <div class="form-group">
                                        <label for="postal_code">CAP</label>
                                        <input type="text" id="postal_code" value="${profile.postal_code || ""}" placeholder="37100" pattern="[0-9]{5}" class="editable-field" />
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" id="save-btn" class="btn-submit" disabled>Salva Modifiche</button>
                                </div>
                                <div id="form-status" class="form-status"></div>
                            </form>
                        </div>

                        <div class="document-section">
                            <div class="section-header">
                                <h3>Documenti</h3>
                            </div>
                            ${
                                profile.document_url
                                    ? `
                                <div class="document-preview">
                                    <div class="doc-status doc-uploaded">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                        <span>Documento caricato</span>
                                    </div>
                                    <div class="document-actions">
                                        <a href="${profile.document_url}" target="_blank" class="btn-view">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                            Visualizza
                                        </a>
                                        <button id="delete-doc" class="btn-delete-doc">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                            Elimina
                                        </button>
                                    </div>
                                </div>
                            `
                                    : `
                                <form id="upload-form" class="upload-area">
                                    <input type="file" id="doc-file" accept=".pdf" style="display:none" />
                                    <button type="button" id="upload-trigger-btn" class="btn-upload">Carica Documento</button>
                                    <div id="upload-status" class="upload-status"></div>
                                </form>
                            `
                            }
                        </div>

                    `;

                    if (contentEl) contentEl.innerHTML = formHTML;

                    // Show profile, hide loading
                    if (loadingEl) loadingEl.style.display = "none";
                    if (containerEl) containerEl.style.display = "block";

                    // Setup form handlers
                    setupChangeDetection(profile);
                    setupProfileFormHandler(profile);
                    setupDeleteAccount(profile);
                    setupAvatarUpload(profile.id);
                    if (profile.document_url) {
                        setupDeleteHandler(profile.id);
                    } else {
                        setupUploadHandler(profile.id);
                    }

                    // GSAP Entrance Animations
                    animateEntrance();
                } catch (error) {
                    console.error("Error loading profile:", error);
                    window.location.href = "/daivai/login";
                }
            }

            function animateEntrance() {
                // @ts-ignore
                if (typeof gsap === "undefined") return;

                const tl = (window as any).gsap.timeline({
                    defaults: { ease: "power3.out" },
                });

                tl.from(".profile-hero-title", {
                    y: -40,
                    opacity: 0,
                    duration: 0.6,
                })
                    .from(
                        ".profile-avatar",
                        {
                            scale: 0,
                            opacity: 0,
                            duration: 0.5,
                            ease: "back.out(1.7)",
                        },
                        "-=0.3",
                    )
                    .from(
                        ".profile-user-name",
                        { y: 20, opacity: 0, duration: 0.4 },
                        "-=0.2",
                    )
                    .from(
                        ".profile-user-email",
                        { y: 20, opacity: 0, duration: 0.3 },
                        "-=0.2",
                    )
                    .from(
                        ".admin-badge",
                        { scale: 0.8, opacity: 0, duration: 0.3 },
                        "-=0.1",
                    )
                    .from(
                        ".profile-card",
                        { y: 40, opacity: 0, duration: 0.6 },
                        "-=0.2",
                    )
                    .from(
                        ".profile-action-bar",
                        { y: 30, opacity: 0, duration: 0.4 },
                        "-=0.3",
                    );
            }

            function setupChangeDetection(profile: any) {
                const saveBtn = document.getElementById(
                    "save-btn",
                ) as HTMLButtonElement;
                const editableFields =
                    document.querySelectorAll(".editable-field");

                // Store original values to detect changes
                const originalValues: Record<string, string> = {};
                editableFields.forEach((field) => {
                    const input = field as HTMLInputElement;
                    originalValues[input.id] = input.value;
                });

                function checkForChanges() {
                    let hasChanges = false;
                    editableFields.forEach((field) => {
                        const input = field as HTMLInputElement;
                        if (input.value !== originalValues[input.id]) {
                            hasChanges = true;
                        }
                    });
                    if (saveBtn) {
                        saveBtn.disabled = !hasChanges;
                        if (hasChanges) {
                            saveBtn.classList.add("active");
                        } else {
                            saveBtn.classList.remove("active");
                        }
                    }
                }

                // Listen for input changes on all editable fields
                editableFields.forEach((field) => {
                    field.addEventListener("input", checkForChanges);
                });
            }

            function setupProfileFormHandler(profile: any) {
                const form = document.getElementById("profile-form");
                const status = document.getElementById("form-status");

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const formData = {
                        first_name: (
                            document.getElementById(
                                "first_name",
                            ) as HTMLInputElement
                        )?.value,
                        last_name: (
                            document.getElementById(
                                "last_name",
                            ) as HTMLInputElement
                        )?.value,
                        birth_date: (
                            document.getElementById(
                                "birth_date",
                            ) as HTMLInputElement
                        )?.value,
                        phone: (
                            document.getElementById("phone") as HTMLInputElement
                        )?.value,
                        address: (
                            document.getElementById(
                                "address",
                            ) as HTMLInputElement
                        )?.value,
                        city: (
                            document.getElementById("city") as HTMLInputElement
                        )?.value,
                        postal_code: (
                            document.getElementById(
                                "postal_code",
                            ) as HTMLInputElement
                        )?.value,
                    };

                    if (status) {
                        status.textContent = "Salvataggio...";
                        status.className = "form-status loading";
                    }

                    const { error } = await supabase
                        .from("profiles")
                        .update(formData)
                        .eq("id", profile.id);

                    if (error) {
                        if (status) {
                            status.textContent = `Errore: ${error.message}`;
                            status.className = "form-status error";
                        }
                    } else {
                        if (status) {
                            status.textContent =
                                "✓ Profilo aggiornato con successo!";
                            status.className = "form-status success";
                        }

                        // Disable save button again and update original values
                        const saveBtn = document.getElementById(
                            "save-btn",
                        ) as HTMLButtonElement;
                        if (saveBtn) saveBtn.disabled = true;

                        // Update stored original values to current
                        const editableFields =
                            document.querySelectorAll(".editable-field");
                        editableFields.forEach((field) => {
                            const input = field as HTMLInputElement;
                            (input as any).__originalValue = input.value;
                        });

                        // Clear status after delay
                        setTimeout(() => {
                            if (status) {
                                status.textContent = "";
                                status.className = "form-status";
                            }
                        }, 3000);
                    }
                });
            }

            function setupUploadHandler(userId: string) {
                const form = document.getElementById("upload-form");
                const status = document.getElementById("upload-status");
                const fileInput = document.getElementById(
                    "doc-file",
                ) as HTMLInputElement;
                const triggerBtn =
                    document.getElementById("upload-trigger-btn");

                // Button triggers hidden file input
                triggerBtn?.addEventListener("click", () => {
                    fileInput?.click();
                });

                // Auto-upload when file is selected
                fileInput?.addEventListener("change", async () => {
                    if (!fileInput || !fileInput.files) {
                        if (status) {
                            status.textContent =
                                "Errore: elemento file non trovato";
                            status.className = "upload-status error";
                        }
                        return;
                    }

                    const file = fileInput.files[0];
                    if (!file) {
                        if (status) {
                            status.textContent = "Seleziona un file";
                            status.className = "upload-status error";
                        }
                        return;
                    }

                    if (file.type !== "application/pdf") {
                        if (status) {
                            status.textContent = "Il file deve essere un PDF";
                            status.className = "upload-status error";
                        }
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        if (status) {
                            status.textContent = "Il file non può superare 5MB";
                            status.className = "upload-status error";
                        }
                        return;
                    }

                    if (status) {
                        status.textContent = "Caricamento...";
                        status.className = "upload-status loading";
                    }

                    const filePath = `${userId}/document.pdf`;
                    const { error: uploadError } = await supabase.storage
                        .from("user-documents")
                        .upload(filePath, file, { upsert: true });

                    if (uploadError) {
                        if (status) {
                            status.textContent = `Errore: ${uploadError.message}`;
                            status.className = "upload-status error";
                        }
                        return;
                    }

                    const {
                        data: { publicUrl },
                    } = supabase.storage
                        .from("user-documents")
                        .getPublicUrl(filePath);

                    const { error: updateError } = await supabase
                        .from("profiles")
                        .update({ document_url: publicUrl })
                        .eq("id", userId);

                    if (updateError) {
                        if (status) {
                            status.textContent = `Errore: ${updateError.message}`;
                            status.className = "upload-status error";
                        }
                    } else {
                        if (status) {
                            status.textContent = "✓ Documento caricato!";
                            status.className = "upload-status success";
                        }
                        setTimeout(() => location.reload(), 1500);
                    }
                });
            }

            function setupDeleteHandler(userId: string) {
                const btn = document.getElementById(
                    "delete-doc",
                ) as HTMLButtonElement | null;

                btn?.addEventListener("click", async () => {
                    if (!confirm("Vuoi eliminare il documento?")) return;

                    btn.textContent = "Eliminazione...";
                    btn.disabled = true;

                    const filePath = `${userId}/document.pdf`;
                    await supabase.storage
                        .from("user-documents")
                        .remove([filePath]);
                    await supabase
                        .from("profiles")
                        .update({ document_url: null })
                        .eq("id", userId);

                    location.reload();
                });
            }

            // Logout handler
            const logoutBtn = document.getElementById("logout-btn");
            logoutBtn?.addEventListener("click", async () => {
                await supabase.auth.signOut();
                window.location.href = "/daivai/";
            });

            // Delete Account Logic
            function setupDeleteAccount(profile: any) {
                const deleteBtn = document.getElementById("delete-account-btn");
                const modal = document.getElementById("delete-modal");
                const closeModalBtns = document.querySelectorAll(
                    ".close-modal, .btn-cancel-modal",
                );
                const confirmDeleteBtn = document.getElementById(
                    "confirm-delete-btn",
                ) as HTMLButtonElement;
                const confirmInput = document.getElementById(
                    "confirm-text",
                ) as HTMLInputElement;

                // Open Modal
                deleteBtn?.addEventListener("click", () => {
                    if (modal) modal.style.display = "flex";
                    if (confirmInput) {
                        confirmInput.value = "";
                        confirmInput.focus();
                    }
                });

                // Close Modal
                const closeModal = () => {
                    if (modal) modal.style.display = "none";
                };

                closeModalBtns.forEach((btn) => {
                    btn.addEventListener("click", closeModal);
                });

                // Close on outside click
                window.addEventListener("click", (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });

                // Confirmation Validation — must type "Conferma"
                confirmInput?.addEventListener("input", (e) => {
                    const target = e.target as HTMLInputElement;
                    if (confirmDeleteBtn) {
                        const isMatch = target.value === "Conferma";
                        confirmDeleteBtn.disabled = !isMatch;
                        if (isMatch) {
                            confirmDeleteBtn.classList.add("active");
                        } else {
                            confirmDeleteBtn.classList.remove("active");
                        }
                    }
                });

                // Confirm Delete
                confirmDeleteBtn?.addEventListener("click", async () => {
                    try {
                        confirmDeleteBtn.textContent = "Eliminazione...";
                        confirmDeleteBtn.disabled = true;

                        // 1. Delete Document if exists
                        if (profile.document_url) {
                            const filePath = `${profile.id}/document.pdf`;
                            await supabase.storage
                                .from("user-documents")
                                .remove([filePath]);
                        }

                        // 2. Delete Profile Data
                        const { error } = await supabase
                            .from("profiles")
                            .delete()
                            .eq("id", profile.id);

                        if (error) throw error;

                        // 3. Sign Out
                        await supabase.auth.signOut();

                        // 4. Redirect
                        window.location.href = "/daivai/";
                    } catch (error) {
                        console.error("Delete error:", error);
                        alert(
                            "Errore durante l'eliminazione del profilo. Riprova.",
                        );
                        confirmDeleteBtn.textContent =
                            "Elimina Definitivamente";
                        confirmDeleteBtn.disabled = false;
                    }
                });
            }

            declare var Cropper: any;

            function setupAvatarUpload(userId: string) {
                const avatarBtn = document.getElementById("profile-avatar");
                const avatarInput = document.getElementById(
                    "avatar-input",
                ) as HTMLInputElement;
                const cropperModal = document.getElementById("cropper-modal");
                const cropperImage = document.getElementById(
                    "cropper-image",
                ) as HTMLImageElement;
                const saveCroppedBtn =
                    document.getElementById("save-cropped-btn");
                const closeCropperBtns = document.querySelectorAll(
                    ".close-cropper, .btn-cancel-cropper",
                );

                let cropper: any = null;

                avatarBtn?.addEventListener("click", () => {
                    avatarInput?.click();
                });

                avatarInput?.addEventListener("change", (e: any) => {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;

                    const file = files[0];
                    if (!file.type.startsWith("image/")) {
                        alert("Per favore seleziona un'immagine.");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event: any) => {
                        if (cropperImage) {
                            cropperImage.src = event.target.result;
                            if (cropperModal)
                                cropperModal.style.display = "flex";

                            if (cropper) cropper.destroy();

                            cropper = new Cropper(cropperImage, {
                                aspectRatio: 1,
                                viewMode: 3,
                                dragMode: "move",
                                guides: true,
                                center: true,
                                highlight: false,
                                cropBoxMovable: false,
                                cropBoxResizable: false,
                                toggleDragModeOnDblclick: false,
                                movable: true,
                                zoomable: true,
                                scalable: false,
                                autoCropArea: 1,
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                });

                const closeCropper = () => {
                    if (cropperModal) cropperModal.style.display = "none";
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    if (avatarInput) avatarInput.value = "";
                };

                closeCropperBtns.forEach((btn) =>
                    btn.addEventListener("click", closeCropper),
                );

                saveCroppedBtn?.addEventListener("click", async () => {
                    if (!cropper) return;

                    saveCroppedBtn.textContent = "Salvataggio...";
                    (saveCroppedBtn as HTMLButtonElement).disabled = true;

                    cropper
                        .getCroppedCanvas({
                            width: 400,
                            height: 400,
                        })
                        .toBlob(async (blob: Blob) => {
                            if (!blob) return;

                            try {
                                const filePath = `${userId}/avatar-${Date.now()}.png`;
                                const bucketName = "user-documents";

                                const { error: uploadError } =
                                    await supabase.storage
                                        .from(bucketName)
                                        .upload(filePath, blob, {
                                            contentType: "image/png",
                                            upsert: true,
                                        });

                                if (uploadError) throw uploadError;

                                const {
                                    data: { publicUrl },
                                } = supabase.storage
                                    .from(bucketName)
                                    .getPublicUrl(filePath);

                                const { error: updateError } = await supabase
                                    .from("profiles")
                                    .update({ avatar_url: publicUrl })
                                    .eq("id", userId);

                                if (updateError) throw updateError;

                                location.reload();
                            } catch (error) {
                                console.error("Avatar upload error:", error);
                                alert(
                                    "Errore durante il caricamento della foto profilo.",
                                );
                                saveCroppedBtn.textContent = "Salva";
                                (saveCroppedBtn as HTMLButtonElement).disabled =
                                    false;
                            }
                        }, "image/png");
                });
            }

            // Load profile on page load
            loadProfile();
        </script>

        <!-- GSAP and Cropper CDN -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"
        ></script>
    </body>
</html>

<style>
    /* ========================================
       PROFILE PAGE — Brand-Consistent Design
       ======================================== */

    body {
        font-family: "Poppins", sans-serif;
        background-color: var(--primary-color);
        min-height: 100vh;
        color: white;
        overflow-x: hidden;
    }

    .profile-page {
        min-height: 100vh;
        padding: 0 1.5rem 4rem;
    }

    /* ── Loading State ──────────────────── */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
        gap: 1.5rem;
        color: var(--secondary-color);
        font-size: 1.1rem;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid rgba(245, 229, 144, 0.2);
        border-top-color: var(--secondary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* ── Hero Header ────────────────────── */
    .profile-hero {
        text-align: center;
        padding: 8rem 1rem 3rem;
    }

    .profile-hero-title {
        font-family: "Condenso", sans-serif;
        font-size: clamp(5rem, 18vw, 12rem);
        font-weight: 400;
        line-height: 0.9;
        letter-spacing: 0.02em;
        background: linear-gradient(
            180deg,
            var(--secondary-color) 0%,
            rgba(245, 229, 144, 0.6) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 2rem;
    }

    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(
            135deg,
            var(--secondary-color),
            rgba(245, 229, 144, 0.7)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.2rem;
        box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.2),
            0 0 0 4px rgba(245, 229, 144, 0.15);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        color: white;
    }

    .profile-avatar:hover .avatar-overlay {
        opacity: 1;
    }

    .profile-avatar span {
        font-family: "Poppins", sans-serif;
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary-color);
        letter-spacing: 2px;
    }

    .profile-user-name {
        font-family: "Poppins", sans-serif;
        font-size: 1.8rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.3rem;
    }

    .profile-user-email {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 1rem;
    }

    .admin-badge {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.2rem;
        background: var(--secondary-color);
        color: var(--primary-color);
        border-radius: 40px;
        font-family: "Poppins", sans-serif;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin: 0 auto;
        width: fit-content;
    }

    /* ── Card Container ─────────────────── */
    .profile-card {
        max-width: 720px;
        margin: 0 auto 2rem;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 40px;
        padding: 2.5rem 2rem;
        color: #1a1a1a;
    }

    /* ── Form Section ───────────────────── */
    .form-section {
        margin-bottom: 2.5rem;
    }

    :global(.form-header) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .form-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-header h3,
    .section-header h3 {
        font-family: "Poppins", sans-serif;
        color: #1a1a1a;
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        letter-spacing: 0.5px;
    }

    :global(.section-header) {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }

    .btn-edit-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.4rem;
        background: transparent;
        color: var(--secondary-color);
        border: 1.5px solid rgba(245, 229, 144, 0.4);
        border-radius: 40px;
        font-family: "Poppins", sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-edit-toggle:hover {
        background: rgba(245, 229, 144, 0.1);
        border-color: var(--secondary-color);
        transform: translateY(-1px);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    :global(.form-group label) {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--primary-color);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 0.4rem;
    }

    :global(.form-group input) {
        width: 100%;
        max-width: 100%;
        padding: 0.85rem 1rem;
        background: #f8f8f8;
        border: 1.5px solid rgba(0, 0, 0, 0.08);
        border-radius: 40px;
        color: #1a1a1a;
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        transition: all 0.3s ease;
        box-sizing: border-box;
        display: block;
    }

    :global(.form-group input[type="date"]) {
        -webkit-appearance: none;
        appearance: none;
        min-height: 3rem; /* Match the height of other inputs */
    }

    :global(.form-group input:focus) {
        outline: none;
        border-color: var(--secondary-color);
        background: white;
        box-shadow: 0 0 0 3px rgba(245, 229, 144, 0.1);
    }

    :global(.form-group input.always-readonly) {
        background: transparent;
        border-color: transparent;
        padding-left: 0;
        cursor: default;
        opacity: 0.5;
    }

    /* ── Form Actions ───────────────────── */
    :global(.form-actions) {
        margin-top: 1.5rem;
    }

    :global(.btn-submit) {
        width: 100%;
        padding: 0.85rem 1rem !important;
        background: var(--primary-color) !important;
        border: none !important;
        border-radius: 40px !important;
        color: var(--secondary-color) !important;
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    :global(.btn-submit:hover:not(:disabled)) {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }

    :global(.btn-submit:disabled) {
        background: #f0f0f0 !important;
        color: #b0b0b0 !important;
        border: 1px solid #e0e0e0 !important;
        cursor: not-allowed;
    }

    :global(.btn-submit.active) {
        background: #1a1a1a !important;
        color: white !important;
        border: 1px solid rgba(0, 0, 0, 0.1) !important;
    }

    /* ── Form Status ────────────────────── */
    .form-status,
    .upload-status {
        margin-top: 1rem;
        padding: 0.7rem 1.2rem;
        border-radius: 40px;
        font-weight: 500;
        font-size: 0.9rem;
        text-align: center;
    }

    .form-status.loading,
    .upload-status.loading {
        background: rgba(245, 229, 144, 0.1);
        color: var(--secondary-color);
    }

    .form-status.success,
    .upload-status.success {
        background: rgba(40, 167, 69, 0.15);
        color: #5cb85c;
    }

    .form-status.error,
    .upload-status.error {
        background: rgba(220, 53, 69, 0.15);
        color: #ff6b7a;
    }

    /* ── Document Section ───────────────── */
    .document-section {
        margin-bottom: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .document-preview {
        text-align: center;
    }

    .doc-status {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.7rem 1.5rem;
        border-radius: 40px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 1.2rem;
    }

    .doc-uploaded {
        background: rgba(40, 167, 69, 0.12);
        color: #5cb85c;
    }

    .document-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }

    .btn-view {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.5rem;
        background: rgba(245, 229, 144, 0.12);
        color: var(--secondary-color);
        border: 1px solid rgba(245, 229, 144, 0.2);
        border-radius: 40px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-view:hover {
        background: rgba(245, 229, 144, 0.2);
        transform: translateY(-1px);
    }

    .btn-delete-doc {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.5rem;
        background: rgba(255, 59, 48, 0.1);
        color: #ff6b7a;
        border: 1px solid rgba(255, 59, 48, 0.2);
        border-radius: 40px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-delete-doc:hover {
        background: rgba(255, 59, 48, 0.2);
    }

    /* ── Upload Area ────────────────────── */
    .upload-area {
        text-align: center;
        padding: 2.5rem 1.5rem;
        border: 2px dashed rgba(245, 229, 144, 0.2);
        border-radius: 40px;
        background: rgba(245, 229, 144, 0.03);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: rgba(245, 229, 144, 0.4);
        background: rgba(245, 229, 144, 0.06);
    }

    .upload-icon {
        margin-bottom: 1rem;
    }

    .upload-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
        margin-bottom: 0.3rem;
    }

    .upload-hint {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.8rem;
        margin-bottom: 1.2rem;
    }

    #doc-file {
        display: block;
        width: 100%;
        max-width: 300px;
        margin: 0 auto 1rem;
        padding: 0.8rem;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 40px;
        color: white;
        font-size: 0.85rem;
        cursor: pointer;
    }

    :global(.btn-upload) {
        width: 100%;
        padding: 0.85rem 1rem !important;
        background: #1a1a1a !important;
        border: 1.5px solid rgba(255, 255, 255, 0.25) !important;
        border-radius: 40px !important;
        color: white !important;
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    :global(.btn-upload:hover) {
        border-color: var(--secondary-color);
        background: rgba(245, 229, 144, 0.06) !important;
        box-shadow: 0 0 0 3px rgba(245, 229, 144, 0.1);
    }

    .btn-delete-profile {
        background: #1a1a1a;
        color: #ff6b7a;
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-delete-profile:hover {
        border-color: rgba(255, 59, 48, 0.4);
        background: rgba(255, 59, 48, 0.1);
    }

    /* ── Action Bar ─────────────────────── */
    .profile-action-bar {
        max-width: 720px;
        margin: 0 auto 2rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 40px;
        font-family: "Poppins", sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        border: none;
    }

    .btn-home {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-home:hover {
        background: rgba(255, 255, 255, 0.14);
        transform: translateY(-1px);
    }

    .btn-admin-panel {
        background: var(--secondary-color);
        color: var(--primary-color);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .btn-admin-panel:hover {
        background: var(--secondary-color);
        filter: brightness(0.95);
        transform: translateY(-1px);
    }

    .btn-logout {
        background: white;
        color: #ff6b7a;
        border: 1px solid rgba(255, 59, 48, 0.15);
        margin-left: auto;
    }

    .btn-logout:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
    }

    /* ── Modal ──────────────────────────── */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
        background: #1a1a2e;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 40px;
        width: 90%;
        max-width: 460px;
        padding: 2rem;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
        animation: scaleUp 0.25s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes scaleUp {
        from {
            transform: scale(0.92);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .modal-header h3 {
        color: white;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .close-modal {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 1.8rem;
        line-height: 1;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: white;
    }

    .modal-body p {
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.6;
        font-size: 0.9rem;
        margin-bottom: 1.2rem;
    }

    .confirmation-input label {
        display: block;
        margin-bottom: 0.6rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
    }

    .confirmation-input input {
        width: 100%;
        padding: 0.85rem 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        border-radius: 40px;
        color: white;
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        transition: all 0.3s ease;
    }

    .confirmation-input input:focus {
        outline: none;
        border-color: #ff6b7a;
        background: rgba(255, 59, 48, 0.04);
    }

    .modal-footer {
        margin-top: 1.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    /* ── Cropper Specific ───────────────── */
    .cropper-container {
        max-width: 500px !important;
    }

    .img-container {
        width: 100%;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        background: #000;
        border-radius: 40px;
    }

    .img-container img {
        display: block;
    }

    .btn-cancel-cropper {
        flex: 1;
        justify-content: center;
        color: #ff6b7a !important;
        font-size: 0.95rem !important;
        font-weight: 600 !important;
    }

    #save-cropped-btn {
        flex: 2;
        background: #fb6068 !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        font-size: 0.95rem !important;
        font-weight: 600 !important;
    }

    .close-cropper {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        font-size: 1.8rem;
        line-height: 1;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-cropper:hover {
        color: white;
    }

    .btn-cancel-modal {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        padding: 0.7rem 1.2rem;
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        font-size: 0.85rem;
        transition: color 0.2s;
    }

    .btn-cancel-modal:hover {
        color: white;
    }

    .btn-delete-confirm {
        background: rgba(255, 59, 48, 0.15);
        color: rgba(255, 255, 255, 0.4);
        border: none;
        padding: 0.7rem 1.4rem;
        border-radius: 40px;
        cursor: not-allowed;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .btn-delete-confirm.active {
        background: #ff3b30;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(255, 59, 48, 0.3);
    }

    .btn-delete-confirm.active:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(255, 59, 48, 0.4);
    }

    /* ── Responsive ─────────────────────── */
    @media (max-width: 640px) {
        .profile-page {
            padding: 0 1rem 3rem;
        }

        .profile-hero {
            padding: 6rem 1rem 2rem;
        }

        .profile-hero-title {
            font-size: clamp(4rem, 22vw, 8rem);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
        }

        .profile-avatar span {
            font-size: 1.8rem;
        }

        .profile-user-name {
            font-size: 1.4rem;
        }

        .profile-card {
            padding: 1.5rem 1.2rem;
            border-radius: 40px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .danger-zone {
            flex-direction: column;
            text-align: center;
        }

        .profile-action-bar {
            flex-direction: column;
        }

        .btn-logout {
            margin-left: 0;
        }

        .document-actions {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
