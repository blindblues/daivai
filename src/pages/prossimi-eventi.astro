---
import "../styles/global.css";
import NavbarAuth from "../components/ui/NavbarAuth.astro";
import ScrollArrow from "../components/ui/ScrollArrow.astro";
---

<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Prossimi Eventi - Dai Vai</title>

        <!-- Favicon -->
        <link
            rel="icon"
            type="image/svg+xml"
            href="/daivai/images/DaiVai.svg"
        />
        <link
            rel="preload"
            href="/daivai/fonts/condenso/Condenso-Regular.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
        <meta name="theme-color" content="#FB6068" />
        <meta
            name="description"
            content="Scopri i prossimi eventi organizzati da Dai Vai: tornei, escursioni e molto altro."
        />
    </head>
    <body>
        <NavbarAuth />

        <main class="page-content">
            <section
                class="viewport-section combined-section page-header-section"
            >
                <div class="text-gradient-wrapper">
                    <div class="gradient-text-group spacing-prossimi-eventi">
                        <h2 class="condenso-text shine-reflection reveal-chars">
                            PROSSIMI
                        </h2>
                        <h2 class="condenso-text shine-reflection reveal-chars">
                            EVENTI
                        </h2>
                    </div>
                </div>

                <div style="margin-top: -7rem; margin-bottom: -1rem;">
                    <ScrollArrow class="arrow-icon" />
                </div>

                <!-- Card Slider â€” popolato dinamicamente -->
                <div class="events-slider-wrapper" style="margin-top: 1rem;">
                    <div class="events-slider" id="events-slider">
                        <!-- Skeleton loader -->
                        <div class="event-skeleton"></div>
                        <div class="event-skeleton"></div>
                        <div class="event-skeleton"></div>
                    </div>
                </div>

                <!-- Messaggio nessun evento -->
                <div
                    id="no-events-msg"
                    class="no-events-msg"
                    style="display:none;"
                >
                    <p>Nessun evento in programma al momento. Torna presto!</p>
                </div>
            </section>
        </main>

        <footer class="site-footer">
            <img
                src="/daivai/images/DaiVai-yellow.svg"
                alt="Dai e Vai Logo"
                class="footer-logo"
            />
            <p
                style="color: var(--secondary-color); font-family: 'Poppins'; margin-top: 1rem;"
            >
                Â© 2026 Dai Vai - Tutti i diritti riservati
            </p>
        </footer>

        <script>
            import { initAnimations } from "../scripts/animations.js";
            import {
                getUpcomingEvents,
                joinEvent,
                leaveEvent,
                isUserParticipating,
            } from "@/lib/database/events";
            import { supabase } from "@/lib/client";

            window.addEventListener("load", () => {
                initAnimations();
            });

            // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function formatDate(dateStr: string): string {
                const d = new Date(dateStr);
                return d.toLocaleDateString("it-IT", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                });
            }

            function buildEventCard(
                event: any,
                participating: boolean,
            ): string {
                const isFull =
                    event.max_participants !== null &&
                    event.participantsCount >= event.max_participants;
                const fillPct = event.max_participants
                    ? Math.min(
                          (event.participantsCount / event.max_participants) *
                              100,
                          100,
                      )
                    : 0;
                const PLACEHOLDER =
                    "/daivai/images/blue-sky-background-with-clouds-free-photo.webp";

                let btnClass = "btn-partecipa";
                let btnLabel = "Partecipa";
                let btnDisabled = "";
                if (participating) {
                    btnClass += " btn-iscritto";
                    btnLabel = "Annulla iscrizione";
                } else if (isFull) {
                    btnClass += " btn-full";
                    btnLabel = "Completo";
                    btnDisabled = "disabled";
                }

                return `
                <div class="event-card" data-event-id="${event.id}">
                    <div class="event-card-image">
                        <img src="${event.image_url ?? PLACEHOLDER}" alt="${event.title}" loading="lazy" />
                        ${event.cost ? `<div class="event-cost-badge">${event.cost}</div>` : ""}
                    </div>
                    <div class="event-card-content">
                        <h3 class="event-card-title">${event.title}</h3>
                        <p class="event-card-description">${event.description ?? ""}</p>
                        <div class="event-card-details">
                            <div class="event-detail-item">
                                <span class="event-detail-icon">ğŸ“…</span>
                                <span class="event-detail-text">${formatDate(event.event_date)}</span>
                            </div>
                            ${
                                event.departure_time
                                    ? `
                            <div class="event-detail-item">
                                <span class="event-detail-icon">ğŸ•</span>
                                <span class="event-detail-text">${event.departure_time}${event.return_time ? ` - ${event.return_time}` : ""}</span>
                            </div>`
                                    : ""
                            }
                            ${
                                event.location
                                    ? `
                            <div class="event-detail-item">
                                <span class="event-detail-icon">ğŸ“</span>
                                <span class="event-detail-text">${event.location}</span>
                            </div>`
                                    : ""
                            }
                        </div>
                        <div class="event-card-footer">
                            <div class="participants-counter">
                                <div class="counter-bar-wrapper">
                                    <div class="counter-bar-fill" style="width:${fillPct}%"></div>
                                </div>
                                <span class="counter-text">
                                    <span class="counter-current">${event.participantsCount}</span>
                                    ${event.max_participants ? `/${event.max_participants}` : ""} partecipanti
                                </span>
                            </div>
                            <button class="${btnClass}" data-event-id="${event.id}" data-is-participating="${participating}" ${btnDisabled}>
                                ${btnLabel}
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            // â”€â”€â”€ Caricamento eventi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async function loadEvents() {
                const slider = document.getElementById("events-slider");
                const noEventsMsg = document.getElementById("no-events-msg");
                if (!slider) return;

                // Utente corrente
                const {
                    data: { user },
                } = await supabase.auth.getUser();

                // Carica eventi futuri
                const { data: events, error } = await getUpcomingEvents();

                // Rimuovi skeleton
                slider.innerHTML = "";

                if (error || !events || events.length === 0) {
                    if (noEventsMsg) noEventsMsg.style.display = "flex";
                    return;
                }

                // Per ogni evento, controlla se l'utente partecipa
                const participatingMap: Record<string, boolean> = {};
                if (user) {
                    await Promise.all(
                        events.map(async (ev: any) => {
                            const { data } = await isUserParticipating(ev.id);
                            participatingMap[ev.id] = data ?? false;
                        }),
                    );
                }

                // Render cards
                slider.innerHTML = events
                    .map((ev: any) =>
                        buildEventCard(ev, participatingMap[ev.id] ?? false),
                    )
                    .join("");

                // Attach listeners ai bottoni
                attachButtonListeners(user);
            }

            // â”€â”€â”€ Gestione click Partecipa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function attachButtonListeners(user: any) {
                document
                    .querySelectorAll<HTMLButtonElement>(".btn-partecipa")
                    .forEach((btn) => {
                        btn.addEventListener("click", async () => {
                            if (!user) {
                                window.location.href = "/daivai/login";
                                return;
                            }

                            const eventId = btn.dataset.eventId!;
                            const isParticipating =
                                btn.dataset.isParticipating === "true";
                            btn.disabled = true;
                            btn.textContent = "...";

                            if (isParticipating) {
                                const { error } = await leaveEvent(eventId);
                                if (!error) await loadEvents();
                            } else {
                                const { error } = await joinEvent(eventId);
                                if (!error) await loadEvents();
                            }
                        });
                    });
            }

            loadEvents();
        </script>

        <style>
            .page-content {
                background-color: var(--primary-color);
                min-height: 100vh;
                padding-top: 80px;
            }

            .page-header-section {
                justify-content: center;
                padding-bottom: 5rem;
            }

            .site-footer {
                background-color: var(--primary-color);
                padding: 4rem 2rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .gradient-text-group {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .spacing-prossimi-eventi h2.condenso-text {
                margin-bottom: -0.45em !important;
                line-height: 1 !important;
            }

            .spacing-prossimi-eventi h2.condenso-text:last-child {
                margin-bottom: 0 !important;
            }

            h2.condenso-text {
                font-size: clamp(6rem, 20vw, 15rem);
                margin: 0;
            }

            /* Skeleton loader */
            .event-skeleton {
                min-width: 300px;
                max-width: 340px;
                height: 400px;
                border-radius: 16px;
                background: linear-gradient(
                    90deg,
                    rgba(255, 255, 255, 0.05) 25%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0.05) 75%
                );
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
                flex-shrink: 0;
            }

            @keyframes shimmer {
                0% {
                    background-position: 200% 0;
                }
                100% {
                    background-position: -200% 0;
                }
            }

            /* No events message */
            .no-events-msg {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 3rem;
                color: rgba(245, 229, 144, 0.6);
                font-family: "Poppins", sans-serif;
                font-size: 1.1rem;
                text-align: center;
            }

            @media (max-width: 768px) {
                .page-content {
                    padding-top: 60px;
                }
                h2.condenso-text {
                    font-size: clamp(3rem, 12vw, 8rem);
                }
                .spacing-prossimi-eventi h2.condenso-text {
                    margin-bottom: -0.44em !important;
                }
            }
        </style>
    </body>
</html>
