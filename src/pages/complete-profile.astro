---
import "../styles/global.css";
import { supabase } from "@/lib/client";
---

<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Completa il tuo Profilo - Dai Vai</title>
        <link
            rel="icon"
            type="image/svg+xml"
            href="/daivai/images/DaiVai.svg"
        />
    </head>
    <body>
        <div class="complete-profile-page">
            <div class="complete-profile-container">
                <div class="header">
                    <img
                        src="/daivai/images/DaiVai-Yellow.svg"
                        alt="Logo"
                        class="logo"
                    />
                    <h1>BENVENUTO!</h1>
                    <p class="subtitle">Completiamo il tuo profilo</p>
                    <p class="description">
                        I seguenti campi sono <strong>opzionali</strong> ma ci aiutano
                        a offrirti un'esperienza migliore. Puoi compilarli ora o saltare
                        e farlo più tardi nella tua area personale.
                    </p>
                </div>

                <form id="complete-profile-form" class="profile-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="first_name">Nome</label>
                            <input
                                type="text"
                                id="first_name"
                                name="first_name"
                                placeholder="Mario"
                            />
                        </div>
                        <div class="form-group">
                            <label for="last_name">Cognome</label>
                            <input
                                type="text"
                                id="last_name"
                                name="last_name"
                                placeholder="Rossi"
                            />
                        </div>

                        <div class="form-group">
                            <label for="birth_date">Data di Nascita</label>
                            <input
                                type="date"
                                id="birth_date"
                                name="birth_date"
                            />
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefono</label>
                            <input
                                type="tel"
                                id="phone"
                                name="phone"
                                placeholder="+39 123 456 7890"
                            />
                        </div>

                        <div class="form-group full-width">
                            <label for="address">Indirizzo</label>
                            <input
                                type="text"
                                id="address"
                                name="address"
                                placeholder="Via Roma, 10"
                            />
                        </div>

                        <div class="form-group">
                            <label for="city">Città</label>
                            <input
                                type="text"
                                id="city"
                                name="city"
                                placeholder="Verona"
                            />
                        </div>

                        <div class="form-group">
                            <label for="postal_code">CAP</label>
                            <input
                                type="text"
                                id="postal_code"
                                name="postal_code"
                                placeholder="37100"
                                pattern="[0-9]{5}"
                            />
                        </div>
                    </div>

                    <div id="form-status" class="form-status"></div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit"
                            >Salva e Continua</button
                        >
                        <button type="button" id="skip-btn" class="btn-skip"
                            >Salta per Ora</button
                        >
                    </div>
                </form>
            </div>
        </div>

        <script>
            import { supabase } from "@/lib/client";

            async function initCompletionFlow() {
                // Check if user is authenticated
                const {
                    data: { user },
                } = await supabase.auth.getUser();

                if (!user) {
                    window.location.href = "/daivai/login";
                    return;
                }

                // Handle form submission
                const form = document.getElementById("complete-profile-form");
                const status = document.getElementById("form-status");
                const skipBtn = document.getElementById("skip-btn");

                form?.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    if (status) {
                        status.textContent = "Salvataggio...";
                        status.className = "form-status loading";
                    }

                    const formData = {
                        first_name:
                            (
                                document.getElementById(
                                    "first_name",
                                ) as HTMLInputElement
                            )?.value || null,
                        last_name:
                            (
                                document.getElementById(
                                    "last_name",
                                ) as HTMLInputElement
                            )?.value || null,
                        birth_date:
                            (
                                document.getElementById(
                                    "birth_date",
                                ) as HTMLInputElement
                            )?.value || null,
                        phone:
                            (
                                document.getElementById(
                                    "phone",
                                ) as HTMLInputElement
                            )?.value || null,
                        address:
                            (
                                document.getElementById(
                                    "address",
                                ) as HTMLInputElement
                            )?.value || null,
                        city:
                            (
                                document.getElementById(
                                    "city",
                                ) as HTMLInputElement
                            )?.value || null,
                        postal_code:
                            (
                                document.getElementById(
                                    "postal_code",
                                ) as HTMLInputElement
                            )?.value || null,
                        profile_completed: true,
                    };

                    const { error } = await supabase
                        .from("profiles")
                        .update(formData)
                        .eq("id", user.id);

                    if (error) {
                        if (status) {
                            status.textContent = `Errore: ${error.message}`;
                            status.className = "form-status error";
                        }
                    } else {
                        if (status) {
                            status.textContent = "✓ Profilo completato!";
                            status.className = "form-status success";
                        }
                        setTimeout(() => {
                            window.location.href = "/daivai/profile";
                        }, 1500);
                    }
                });

                skipBtn?.addEventListener("click", async () => {
                    // Mark as completed but don't save data
                    await supabase
                        .from("profiles")
                        .update({ profile_completed: true })
                        .eq("id", user.id);

                    window.location.href = "/daivai/profile";
                });
            }

            initCompletionFlow();
        </script>

        <style>
            body {
                font-family: "Gotham", sans-serif;
                background: linear-gradient(
                    135deg,
                    #0f0c29 0%,
                    #302b63 50%,
                    #24243e 100%
                );
                min-height: 100vh;
                color: white;
                margin: 0;
                padding: 0;
            }

            .complete-profile-page {
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }

            .complete-profile-container {
                max-width: 800px;
                width: 100%;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 3rem;
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }

            .header {
                text-align: center;
                margin-bottom: 3rem;
            }

            .logo {
                width: 120px;
                height: auto;
                margin-bottom: 1.5rem;
            }

            .header h1 {
                font-family: var(--font-heading);
                font-size: clamp(2.5rem, 5vw, 4rem);
                margin: 0 0 0.5rem;
                font-weight: 400;
                letter-spacing: 2px;
            }

            .subtitle {
                font-size: 1.3rem;
                color: var(--primary-color);
                margin-bottom: 1rem;
                font-weight: 600;
            }

            .description {
                color: rgba(255, 255, 255, 0.8);
                font-size: 1rem;
                line-height: 1.6;
                max-width: 600px;
                margin: 0 auto;
            }

            .description strong {
                color: var(--primary-color);
            }

            .form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.95rem;
            }

            .form-group input {
                padding: 1rem 1.25rem;
                background: rgba(255, 255, 255, 0.1);
                border: 1.5px solid rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                color: white;
                font-size: 1rem;
                font-family: "Gotham", sans-serif;
                transition: all 0.3s ease;
            }

            .form-group input::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }

            .form-group input:focus {
                outline: none;
                border-color: var(--primary-color);
                background: rgba(255, 255, 255, 0.15);
                box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
            }

            .form-status {
                margin-top: 1rem;
                margin-bottom: 1.5rem;
                padding: 0.8rem 1.5rem;
                border-radius: 8px;
                font-weight: 600;
                text-align: center;
            }

            .form-status.loading {
                background: rgba(var(--primary-rgb), 0.1);
                color: var(--primary-color);
            }

            .form-status.success {
                background: rgba(40, 167, 69, 0.1);
                color: #28a745;
            }

            .form-status.error {
                background: rgba(220, 53, 69, 0.1);
                color: #dc3545;
            }

            .form-actions {
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .btn-submit,
            .btn-skip {
                flex: 1;
                padding: 1.2rem 2rem;
                border-radius: 12px;
                font-weight: 700;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                font-family: "Gotham", sans-serif;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                border: none;
            }

            .btn-submit {
                background: var(--primary-color);
                color: white;
                box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);
            }

            .btn-submit:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.5);
            }

            .btn-skip {
                background: transparent;
                color: rgba(255, 255, 255, 0.7);
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            .btn-skip:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.5);
                color: white;
                transform: translateY(-3px);
            }

            @media (max-width: 768px) {
                .complete-profile-container {
                    padding: 2rem 1.5rem;
                }

                .form-grid {
                    grid-template-columns: 1fr;
                }

                .form-actions {
                    flex-direction: column;
                }

                .btn-submit,
                .btn-skip {
                    width: 100%;
                }
            }
        </style>
    </body>
</html>
