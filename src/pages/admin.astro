---
import "../styles/global.css";
import NavbarAuth from "../components/ui/NavbarAuth.astro";
---

<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin - Dai Vai</title>
        <link
            rel="icon"
            type="image/svg+xml"
            href="/daivai/images/DaiVai.svg"
        />
        <meta name="theme-color" content="#FB6068" />
    </head>
    <body>
        <NavbarAuth />

        <main class="admin-page">
            <!-- Header -->
            <div class="admin-header">
                <h1 class="admin-title condenso-text">PANNELLO<br />ADMIN</h1>
                <p class="admin-subtitle">Gestisci eventi e utenti</p>
            </div>

            <!-- Auth guard message -->
            <div id="auth-guard" class="auth-guard" style="display:none;">
                <p>
                    ‚õî Accesso negato. Devi essere un amministratore per
                    visualizzare questa pagina.
                </p>
                <a href="/daivai/" class="btn-back">Torna alla home</a>
            </div>

            <!-- Admin content (nascosto finch√© non verificato) -->
            <div id="admin-content" style="display:none;">
                <!-- Tab navigation -->
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="events"
                        >üóìÔ∏è Gestione Eventi</button
                    >
                    <button class="tab-btn" data-tab="users"
                        >üë• Gestione Utenti</button
                    >
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- TAB: EVENTI -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="tab-events" class="tab-content active">
                    <!-- Bottone nuovo evento -->
                    <div class="section-header">
                        <h2 class="section-title">Eventi</h2>
                        <button id="btn-new-event" class="btn-primary"
                            >+ Nuovo Evento</button
                        >
                    </div>

                    <!-- Form creazione/modifica evento -->
                    <div
                        id="event-form-wrapper"
                        class="form-card"
                        style="display:none;"
                    >
                        <h3 id="form-title" class="form-title">Nuovo Evento</h3>
                        <form id="event-form" class="event-form">
                            <input type="hidden" id="event-id" />

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="event-title">Titolo *</label>
                                    <input
                                        type="text"
                                        id="event-title"
                                        required
                                        placeholder="Nome dell'evento"
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="event-location">Luogo</label>
                                    <input
                                        type="text"
                                        id="event-location"
                                        placeholder="Citt√†, indirizzo..."
                                    />
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="event-description"
                                    >Descrizione</label
                                >
                                <textarea
                                    id="event-description"
                                    rows="3"
                                    placeholder="Descrivi l'evento..."
                                ></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="event-date">Data e ora *</label>
                                    <input
                                        type="datetime-local"
                                        id="event-date"
                                        required
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="event-departure"
                                        >Orario partenza</label
                                    >
                                    <input type="time" id="event-departure" />
                                </div>
                                <div class="form-group">
                                    <label for="event-return"
                                        >Orario ritorno</label
                                    >
                                    <input type="time" id="event-return" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="event-cost">Costo</label>
                                    <input
                                        type="text"
                                        id="event-cost"
                                        placeholder="es. ‚Ç¨25,00 o Gratuito"
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="event-max"
                                        >Max partecipanti</label
                                    >
                                    <input
                                        type="number"
                                        id="event-max"
                                        min="1"
                                        placeholder="es. 50"
                                    />
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="event-image"
                                    >Immagine (JPEG/PNG/WebP, max 5MB)</label
                                >
                                <input
                                    type="file"
                                    id="event-image"
                                    accept="image/jpeg,image/png,image/webp"
                                />
                                <div
                                    id="image-preview-wrapper"
                                    style="display:none; margin-top:0.5rem;"
                                >
                                    <img
                                        id="image-preview"
                                        src=""
                                        alt="Anteprima"
                                        style="max-height:120px; border-radius:8px;"
                                    />
                                </div>
                            </div>

                            <div
                                id="form-error"
                                class="form-error"
                                style="display:none;"
                            >
                            </div>

                            <div class="form-actions">
                                <button
                                    type="button"
                                    id="btn-cancel-form"
                                    class="btn-secondary">Annulla</button
                                >
                                <button
                                    type="submit"
                                    id="btn-submit-form"
                                    class="btn-primary">Salva Evento</button
                                >
                            </div>
                        </form>
                    </div>

                    <!-- Lista eventi -->
                    <div id="events-list" class="events-list">
                        <div class="loading-spinner">Caricamento eventi...</div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- TAB: UTENTI -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="tab-users" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">Utenti registrati</h2>
                    </div>

                    <div id="users-list" class="users-list">
                        <div class="loading-spinner">Caricamento utenti...</div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            import { supabase } from "@/lib/client";
            import {
                getAllEvents,
                createEvent,
                updateEvent,
                deleteEvent,
                uploadEventImage,
            } from "@/lib/database/events";
            import {
                getAllUsers,
                promoteToAdmin,
                demoteFromAdmin,
            } from "@/lib/database/events";
            import { isAdmin } from "@/lib/database/profiles";

            // ‚îÄ‚îÄ‚îÄ Auth Guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async function checkAdmin() {
                const {
                    data: { user },
                } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = "/daivai/login";
                    return false;
                }
                const admin = await isAdmin(user.id);
                if (!admin) {
                    document.getElementById("auth-guard")!.style.display =
                        "flex";
                    return false;
                }
                document.getElementById("admin-content")!.style.display =
                    "block";
                return true;
            }

            // ‚îÄ‚îÄ‚îÄ Tab navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function initTabs() {
                document
                    .querySelectorAll<HTMLButtonElement>(".tab-btn")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            document
                                .querySelectorAll(".tab-btn")
                                .forEach((b) => b.classList.remove("active"));
                            document
                                .querySelectorAll(".tab-content")
                                .forEach((t) => t.classList.remove("active"));
                            btn.classList.add("active");
                            const tabId = `tab-${btn.dataset.tab}`;
                            document
                                .getElementById(tabId)!
                                .classList.add("active");
                        });
                    });
            }

            // ‚îÄ‚îÄ‚îÄ Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function formatDate(dateStr: string): string {
                return new Date(dateStr).toLocaleDateString("it-IT", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                });
            }

            function formatTime(t: string | null | undefined): string {
                if (!t) return "";
                return t.slice(0, 5); // HH:MM
            }

            // ‚îÄ‚îÄ‚îÄ Build preview card (stesso stile pagina eventi) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function buildPreviewCard(ev: any): string {
                const PLACEHOLDER =
                    "/daivai/images/blue-sky-background-with-clouds-free-photo.webp";
                return `
                <div class="event-card admin-preview-card">
                    <div class="event-card-image">
                        <img src="${ev.image_url ?? PLACEHOLDER}" alt="${ev.title}" loading="lazy" />
                        ${ev.cost ? `<div class="event-cost-badge">${ev.cost}</div>` : ""}
                    </div>
                    <div class="event-card-content">
                        <h3 class="event-card-title">${ev.title}</h3>
                        <p class="event-card-description">${ev.description ?? ""}</p>
                        <div class="event-card-details">
                            <div class="event-detail-item">
                                <span class="event-detail-icon">üìÖ</span>
                                <span class="event-detail-text">${formatDate(ev.event_date)}</span>
                            </div>
                            ${
                                ev.departure_time
                                    ? `
                            <div class="event-detail-item">
                                <span class="event-detail-icon">üïê</span>
                                <span class="event-detail-text">${formatTime(ev.departure_time)}${ev.return_time ? ` - ${formatTime(ev.return_time)}` : ""}</span>
                            </div>`
                                    : ""
                            }
                            ${
                                ev.location
                                    ? `
                            <div class="event-detail-item">
                                <span class="event-detail-icon">üìç</span>
                                <span class="event-detail-text">${ev.location}</span>
                            </div>`
                                    : ""
                            }
                            ${
                                ev.max_participants
                                    ? `
                            <div class="event-detail-item">
                                <span class="event-detail-icon">üë•</span>
                                <span class="event-detail-text">${ev.participantsCount ?? 0}/${ev.max_participants} partecipanti</span>
                            </div>`
                                    : ""
                            }
                        </div>
                    </div>
                </div>`;
            }

            // ‚îÄ‚îÄ‚îÄ EVENTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let editingEventId: string | null = null;

            async function loadEvents() {
                const list = document.getElementById("events-list")!;
                list.innerHTML = `<div class="loading-spinner">Caricamento...</div>`;

                const { data: events, error } = await getAllEvents();
                if (error || !events) {
                    list.innerHTML = `<p class="error-msg">Errore nel caricamento degli eventi.</p>`;
                    return;
                }

                if (events.length === 0) {
                    list.innerHTML = `<p class="empty-msg">Nessun evento trovato. Crea il primo!</p>`;
                    return;
                }

                list.innerHTML = events
                    .map(
                        (ev) => `
                    <div class="event-accordion" data-id="${ev.id}">
                        <!-- Header sempre visibile -->
                        <div class="event-accordion-header">
                            ${
                                ev.image_url
                                    ? `<img class="event-row-thumb" src="${ev.image_url}" alt="" onerror="this.style.display='none'" />`
                                    : `<div class="event-row-thumb-placeholder">üì∑</div>`
                            }
                            <div class="event-accordion-info">
                                <span class="event-row-title">${ev.title}</span>
                                <span class="event-row-meta">${formatDate(ev.event_date)} ¬∑ ${ev.location ?? "‚Äî"} ¬∑ ${ev.cost ?? "Gratuito"}</span>
                            </div>
                            <div class="event-accordion-controls">
                                <button class="btn-edit" data-id="${ev.id}">‚úèÔ∏è Modifica</button>
                                <button class="btn-delete" data-id="${ev.id}">üóëÔ∏è Elimina</button>
                                <button class="btn-toggle-preview" data-id="${ev.id}" title="Anteprima">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <!-- Preview espandibile -->
                        <div class="event-accordion-preview" id="preview-${ev.id}" style="display:none;">
                            <div class="preview-label">Anteprima card pubblica</div>
                            ${buildPreviewCard(ev)}
                        </div>
                    </div>
                `,
                    )
                    .join("");

                // Attach listeners
                list.querySelectorAll<HTMLButtonElement>(".btn-edit").forEach(
                    (btn) => {
                        btn.addEventListener("click", () =>
                            openEditForm(btn.dataset.id!, events),
                        );
                    },
                );
                list.querySelectorAll<HTMLButtonElement>(".btn-delete").forEach(
                    (btn) => {
                        btn.addEventListener("click", () =>
                            handleDeleteEvent(btn.dataset.id!),
                        );
                    },
                );
                list.querySelectorAll<HTMLButtonElement>(
                    ".btn-toggle-preview",
                ).forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const id = btn.dataset.id!;
                        const preview = document.getElementById(
                            `preview-${id}`,
                        )!;
                        const isOpen = preview.style.display !== "none";
                        preview.style.display = isOpen ? "none" : "flex";
                        btn.textContent = isOpen ? "üëÅÔ∏è" : "üôà";
                    });
                });
            }

            function openNewForm() {
                editingEventId = null;
                (
                    document.getElementById("form-title") as HTMLElement
                ).textContent = "Nuovo Evento";
                (
                    document.getElementById("event-form") as HTMLFormElement
                ).reset();
                (
                    document.getElementById("event-id") as HTMLInputElement
                ).value = "";
                document.getElementById("event-form-wrapper")!.style.display =
                    "block";
                document
                    .getElementById("event-form-wrapper")!
                    .scrollIntoView({ behavior: "smooth" });
            }

            function openEditForm(eventId: string, events: any[]) {
                const ev = events.find((e) => e.id === eventId);
                if (!ev) return;
                editingEventId = eventId;
                (
                    document.getElementById("form-title") as HTMLElement
                ).textContent = "Modifica Evento";
                (
                    document.getElementById("event-id") as HTMLInputElement
                ).value = ev.id;
                (
                    document.getElementById("event-title") as HTMLInputElement
                ).value = ev.title;
                (
                    document.getElementById(
                        "event-description",
                    ) as HTMLTextAreaElement
                ).value = ev.description ?? "";
                (
                    document.getElementById(
                        "event-location",
                    ) as HTMLInputElement
                ).value = ev.location ?? "";
                (
                    document.getElementById("event-cost") as HTMLInputElement
                ).value = ev.cost ?? "";
                (
                    document.getElementById("event-max") as HTMLInputElement
                ).value = ev.max_participants ?? "";
                // Format date for datetime-local
                const d = new Date(ev.event_date);
                const local = new Date(
                    d.getTime() - d.getTimezoneOffset() * 60000,
                )
                    .toISOString()
                    .slice(0, 16);
                (
                    document.getElementById("event-date") as HTMLInputElement
                ).value = local;
                (
                    document.getElementById(
                        "event-departure",
                    ) as HTMLInputElement
                ).value = ev.departure_time ?? "";
                (
                    document.getElementById("event-return") as HTMLInputElement
                ).value = ev.return_time ?? "";
                document.getElementById("event-form-wrapper")!.style.display =
                    "block";
                document
                    .getElementById("event-form-wrapper")!
                    .scrollIntoView({ behavior: "smooth" });
            }

            async function handleDeleteEvent(eventId: string) {
                if (
                    !confirm(
                        "Sei sicuro di voler eliminare questo evento? L'azione √® irreversibile.",
                    )
                )
                    return;
                const { error } = await deleteEvent(eventId);
                if (error) {
                    alert("Errore durante l'eliminazione: " + error.message);
                } else {
                    await loadEvents();
                }
            }

            async function handleFormSubmit(e: Event) {
                e.preventDefault();
                const submitBtn = document.getElementById(
                    "btn-submit-form",
                ) as HTMLButtonElement;
                const errorDiv = document.getElementById("form-error")!;
                errorDiv.style.display = "none";
                submitBtn.disabled = true;
                submitBtn.textContent = "Salvataggio...";

                const formData = {
                    title: (
                        document.getElementById(
                            "event-title",
                        ) as HTMLInputElement
                    ).value,
                    description:
                        (
                            document.getElementById(
                                "event-description",
                            ) as HTMLTextAreaElement
                        ).value || undefined,
                    event_date: new Date(
                        (
                            document.getElementById(
                                "event-date",
                            ) as HTMLInputElement
                        ).value,
                    ).toISOString(),
                    departure_time:
                        (
                            document.getElementById(
                                "event-departure",
                            ) as HTMLInputElement
                        ).value || undefined,
                    return_time:
                        (
                            document.getElementById(
                                "event-return",
                            ) as HTMLInputElement
                        ).value || undefined,
                    location:
                        (
                            document.getElementById(
                                "event-location",
                            ) as HTMLInputElement
                        ).value || undefined,
                    cost:
                        (
                            document.getElementById(
                                "event-cost",
                            ) as HTMLInputElement
                        ).value || undefined,
                    max_participants: (
                        document.getElementById("event-max") as HTMLInputElement
                    ).value
                        ? parseInt(
                              (
                                  document.getElementById(
                                      "event-max",
                                  ) as HTMLInputElement
                              ).value,
                          )
                        : undefined,
                };

                let savedEventId = editingEventId;

                if (editingEventId) {
                    const { error } = await updateEvent(
                        editingEventId,
                        formData,
                    );
                    if (error) {
                        errorDiv.textContent = "Errore: " + error.message;
                        errorDiv.style.display = "block";
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Salva Evento";
                        return;
                    }
                } else {
                    const { data, error } = await createEvent(formData);
                    if (error || !data) {
                        errorDiv.textContent =
                            "Errore: " + (error?.message ?? "Sconosciuto");
                        errorDiv.style.display = "block";
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Salva Evento";
                        return;
                    }
                    savedEventId = data.id;
                }

                // Upload immagine se presente
                const imageInput = document.getElementById(
                    "event-image",
                ) as HTMLInputElement;
                if (imageInput.files && imageInput.files[0] && savedEventId) {
                    submitBtn.textContent = "Upload immagine...";
                    const { data: imgData, error: imgError } =
                        await uploadEventImage(
                            imageInput.files[0],
                            savedEventId,
                        );
                    if (imgError) {
                        const msg =
                            (imgError as any).message ??
                            JSON.stringify(imgError);
                        errorDiv.textContent =
                            "‚ö†Ô∏è Evento salvato, ma errore upload immagine: " +
                            msg;
                        errorDiv.style.display = "block";
                        console.error("[Admin] Upload error:", imgError);
                    } else if (imgData) {
                        // Mostra URL per debug ‚Äî se l'immagine non appare, il bucket non √® pubblico
                        console.log("[Admin] Immagine caricata:", imgData.url);
                    }
                }

                document.getElementById("event-form-wrapper")!.style.display =
                    "none";
                (
                    document.getElementById("event-form") as HTMLFormElement
                ).reset();
                submitBtn.disabled = false;
                submitBtn.textContent = "Salva Evento";
                await loadEvents();
            }

            // ‚îÄ‚îÄ‚îÄ UTENTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async function loadUsers() {
                const list = document.getElementById("users-list")!;
                list.innerHTML = `<div class="loading-spinner">Caricamento...</div>`;

                const { data: users, error } = await getAllUsers();
                if (error || !users) {
                    list.innerHTML = `<p class="error-msg">Errore nel caricamento degli utenti.</p>`;
                    return;
                }

                if (users.length === 0) {
                    list.innerHTML = `<p class="empty-msg">Nessun utente trovato.</p>`;
                    return;
                }

                list.innerHTML = users
                    .map(
                        (u: any) => `
                    <div class="user-row" data-id="${u.id}">
                        <div class="user-row-info">
                            <span class="user-name">${u.first_name ?? ""} ${u.last_name ?? ""}</span>
                            <span class="user-email">${u.email ?? "‚Äî"}</span>
                            <span class="user-role ${u.role === "admin" ? "role-admin" : "role-user"}">${u.role ?? "user"}</span>
                        </div>
                        <div class="user-row-actions">
                            ${
                                u.role === "admin"
                                    ? `<button class="btn-demote" data-id="${u.id}">‚¨áÔ∏è Rimuovi admin</button>`
                                    : `<button class="btn-promote" data-id="${u.id}">‚¨ÜÔ∏è Promuovi admin</button>`
                            }
                        </div>
                    </div>
                `,
                    )
                    .join("");

                list.querySelectorAll<HTMLButtonElement>(
                    ".btn-promote",
                ).forEach((btn) => {
                    btn.addEventListener("click", async () => {
                        if (!confirm("Promuovere questo utente ad admin?"))
                            return;
                        await promoteToAdmin(btn.dataset.id!);
                        await loadUsers();
                    });
                });

                list.querySelectorAll<HTMLButtonElement>(".btn-demote").forEach(
                    (btn) => {
                        btn.addEventListener("click", async () => {
                            if (
                                !confirm(
                                    "Rimuovere i privilegi admin da questo utente?",
                                )
                            )
                                return;
                            await demoteFromAdmin(btn.dataset.id!);
                            await loadUsers();
                        });
                    },
                );
            }

            // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async function init() {
                const ok = await checkAdmin();
                if (!ok) return;

                initTabs();

                // Event form listeners
                document
                    .getElementById("btn-new-event")!
                    .addEventListener("click", openNewForm);
                document
                    .getElementById("btn-cancel-form")!
                    .addEventListener("click", () => {
                        document.getElementById(
                            "event-form-wrapper",
                        )!.style.display = "none";
                    });
                document
                    .getElementById("event-form")!
                    .addEventListener("submit", handleFormSubmit);

                // Image preview
                document
                    .getElementById("event-image")!
                    .addEventListener("change", (e) => {
                        const file = (e.target as HTMLInputElement).files?.[0];
                        if (file) {
                            const url = URL.createObjectURL(file);
                            (
                                document.getElementById(
                                    "image-preview",
                                ) as HTMLImageElement
                            ).src = url;
                            document.getElementById(
                                "image-preview-wrapper",
                            )!.style.display = "block";
                        }
                    });

                // Tab change ‚Üí load data
                document
                    .querySelectorAll<HTMLButtonElement>(".tab-btn")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            if (btn.dataset.tab === "users") loadUsers();
                        });
                    });

                // Load initial data
                await loadEvents();
            }

            init();
        </script>

        <style>
            .admin-page {
                background-color: var(--primary-color);
                min-height: 100vh;
                padding: 100px 2rem 4rem;
                font-family: "Poppins", sans-serif;
            }

            .admin-header {
                text-align: center;
                margin-bottom: 2.5rem;
            }

            .admin-title {
                font-size: clamp(3rem, 8vw, 6rem);
                color: var(--secondary-color);
                margin: 0;
                line-height: 1;
                text-shadow: 0 0 60px rgba(245, 229, 144, 0.15);
            }

            .admin-subtitle {
                color: rgba(245, 229, 144, 0.6);
                font-size: 1rem;
                margin-top: 0.5rem;
            }

            /* Auth guard */
            .auth-guard {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1.5rem;
                padding: 4rem 2rem;
                color: rgba(245, 229, 144, 0.8);
                font-size: 1.1rem;
                text-align: center;
            }

            .btn-back {
                color: var(--secondary-color);
                text-decoration: none;
                border: 1px solid rgba(245, 229, 144, 0.4);
                padding: 0.5rem 1.5rem;
                border-radius: 8px;
                transition: all 0.2s;
            }

            .btn-back:hover {
                background: rgba(245, 229, 144, 0.1);
            }

            /* Tabs */
            .admin-tabs {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 2rem;
                border-bottom: 1px solid rgba(245, 229, 144, 0.15);
                padding-bottom: 0;
            }

            .tab-btn {
                background: transparent;
                border: none;
                border-bottom: 2px solid transparent;
                color: rgba(245, 229, 144, 0.5);
                font-family: "Poppins", sans-serif;
                font-size: 0.95rem;
                font-weight: 600;
                padding: 0.75rem 1.5rem;
                cursor: pointer;
                transition: all 0.2s;
                margin-bottom: -1px;
            }

            .tab-btn.active {
                color: var(--secondary-color);
                border-bottom-color: var(--secondary-color);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            /* Section header */
            .section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1.5rem;
            }

            .section-title {
                font-size: 1.3rem;
                color: var(--secondary-color);
                margin: 0;
            }

            /* Buttons */
            .btn-primary {
                background: var(--secondary-color);
                color: var(--primary-color);
                border: none;
                padding: 0.6rem 1.4rem;
                border-radius: 10px;
                font-family: "Poppins", sans-serif;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-primary:hover:not(:disabled) {
                background: #fff;
                transform: translateY(-1px);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-secondary {
                background: transparent;
                color: rgba(245, 229, 144, 0.6);
                border: 1px solid rgba(245, 229, 144, 0.3);
                padding: 0.6rem 1.4rem;
                border-radius: 10px;
                font-family: "Poppins", sans-serif;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-secondary:hover {
                border-color: rgba(245, 229, 144, 0.6);
                color: var(--secondary-color);
            }

            /* Form card */
            .form-card {
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(245, 229, 144, 0.15);
                border-radius: 16px;
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .form-title {
                color: var(--secondary-color);
                font-size: 1.1rem;
                margin: 0 0 1.2rem;
            }

            .event-form {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 0.4rem;
            }

            .form-group label {
                font-size: 0.82rem;
                color: rgba(245, 229, 144, 0.7);
                font-weight: 500;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                background: rgba(255, 255, 255, 0.07);
                border: 1px solid rgba(245, 229, 144, 0.2);
                border-radius: 8px;
                padding: 0.6rem 0.8rem;
                color: var(--secondary-color);
                font-family: "Poppins", sans-serif;
                font-size: 0.9rem;
                transition: border-color 0.2s;
                width: 100%;
            }

            .form-group input:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: rgba(245, 229, 144, 0.5);
            }

            .form-group input[type="file"] {
                padding: 0.4rem;
                cursor: pointer;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .form-error {
                background: rgba(251, 96, 104, 0.15);
                border: 1px solid rgba(251, 96, 104, 0.4);
                border-radius: 8px;
                padding: 0.7rem 1rem;
                color: #fb6068;
                font-size: 0.85rem;
            }

            .form-actions {
                display: flex;
                gap: 0.75rem;
                justify-content: flex-end;
            }

            /* Events list ‚Äî accordion */
            .events-list {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .event-accordion {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(245, 229, 144, 0.12);
                border-radius: 16px;
                overflow: hidden;
                transition: border-color 0.2s;
            }

            .event-accordion:hover {
                border-color: rgba(245, 229, 144, 0.25);
            }

            /* Header sempre visibile */
            .event-accordion-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem 1.2rem;
            }

            .event-accordion-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 0.2rem;
                min-width: 0;
            }

            .event-accordion-controls {
                display: flex;
                gap: 0.5rem;
                flex-shrink: 0;
                align-items: center;
            }

            .btn-toggle-preview {
                background: transparent;
                border: 1px solid rgba(245, 229, 144, 0.2);
                border-radius: 8px;
                color: rgba(245, 229, 144, 0.6);
                font-size: 1rem;
                padding: 0.4rem 0.6rem;
                cursor: pointer;
                transition: all 0.2s;
                line-height: 1;
            }

            .btn-toggle-preview:hover {
                border-color: rgba(245, 229, 144, 0.5);
                background: rgba(245, 229, 144, 0.08);
            }

            /* Preview espandibile */
            .event-accordion-preview {
                border-top: 1px solid rgba(245, 229, 144, 0.1);
                padding: 1.5rem;
                background: rgba(0, 0, 0, 0.2);
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }

            .preview-label {
                font-size: 0.72rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: rgba(245, 229, 144, 0.35);
                font-weight: 600;
                align-self: flex-start;
            }

            /* Override dimensioni card nella preview admin */
            .admin-preview-card {
                width: min(85vw, 380px) !important;
                height: auto !important;
                min-height: 420px;
                max-height: 560px;
                flex-shrink: 0;
                scroll-snap-align: none !important;
            }

            .admin-preview-card .event-card-image {
                height: 200px !important;
            }

            .event-row-title {
                font-weight: 600;
                color: var(--secondary-color);
                font-size: 0.95rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .event-row-meta {
                font-size: 0.78rem;
                color: rgba(245, 229, 144, 0.5);
            }

            .event-row-img-url {
                font-size: 0.72rem;
                color: rgba(245, 229, 144, 0.4);
                font-style: italic;
            }

            .event-row-thumb {
                width: 56px;
                height: 56px;
                object-fit: cover;
                border-radius: 10px;
                flex-shrink: 0;
                border: 1px solid rgba(245, 229, 144, 0.2);
            }

            .event-row-thumb-placeholder {
                width: 56px;
                height: 56px;
                border-radius: 10px;
                flex-shrink: 0;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(245, 229, 144, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.4rem;
            }

            .event-row-actions {
                display: flex;
                gap: 0.5rem;
                flex-shrink: 0;
            }

            .btn-edit,
            .btn-delete,
            .btn-promote,
            .btn-demote {
                background: transparent;
                border: 1px solid rgba(245, 229, 144, 0.2);
                border-radius: 8px;
                color: rgba(245, 229, 144, 0.7);
                font-family: "Poppins", sans-serif;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .btn-edit:hover {
                border-color: var(--secondary-color);
                color: var(--secondary-color);
            }
            .btn-delete:hover {
                border-color: #fb6068;
                color: #fb6068;
            }
            .btn-promote:hover {
                border-color: #4ade80;
                color: #4ade80;
            }
            .btn-demote:hover {
                border-color: #fb6068;
                color: #fb6068;
            }

            /* Users list */
            .users-list {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .user-row {
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(245, 229, 144, 0.12);
                border-radius: 12px;
                padding: 1rem 1.2rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
            }

            .user-row-info {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .user-name {
                font-weight: 600;
                color: var(--secondary-color);
                font-size: 0.9rem;
            }

            .user-email {
                font-size: 0.8rem;
                color: rgba(245, 229, 144, 0.5);
            }

            .user-role {
                font-size: 0.72rem;
                font-weight: 700;
                padding: 2px 8px;
                border-radius: 20px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .role-admin {
                background: rgba(245, 229, 144, 0.15);
                color: var(--secondary-color);
            }

            .role-user {
                background: rgba(255, 255, 255, 0.08);
                color: rgba(245, 229, 144, 0.4);
            }

            .user-row-actions {
                flex-shrink: 0;
            }

            /* Misc */
            .loading-spinner {
                text-align: center;
                color: rgba(245, 229, 144, 0.4);
                padding: 2rem;
                font-size: 0.9rem;
            }

            .error-msg {
                color: #fb6068;
                text-align: center;
                padding: 2rem;
            }

            .empty-msg {
                color: rgba(245, 229, 144, 0.4);
                text-align: center;
                padding: 2rem;
            }

            @media (max-width: 768px) {
                .admin-page {
                    padding: 80px 1rem 3rem;
                }
                .event-row {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .user-row {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .form-actions {
                    flex-direction: column;
                }
                .btn-primary,
                .btn-secondary {
                    width: 100%;
                    text-align: center;
                }
            }
        </style>
    </body>
</html>
