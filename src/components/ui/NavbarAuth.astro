---
import Auth from "@/components/features/Auth.astro";
---

<div class="nav-menu-wrapper">
    <!-- Pulsante Hamburger Menu -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Apri Menu">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="hamburger-icon"
        >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="close-icon"
            style="display: none;"
        >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<div class="nav-auth-wrapper">
    <!-- Icona Profilo con Link Dinamico -->
    <a
        href="#"
        id="profile-link"
        class="profile-btn"
        aria-label="Area Personale"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle
                cx="12"
                cy="7"
                r="4"></circle></svg
        >
    </a>
</div>

<!-- Login Modal -->
<div id="login-modal" class="login-modal">
    <div class="login-modal-content">
        <Auth />
    </div>
</div>

<!-- Menu Overlay -->
<div id="menu-overlay" class="menu-overlay">
    <div class="menu-header">
        <a href="/daivai/" aria-label="Home">
            <img
                src="/daivai/images/DaiVai-yellow.svg"
                alt="DaiVai Logo"
                class="menu-logo"
            />
        </a>
    </div>
    <nav class="menu-nav">
        <a href="/daivai/" class="menu-link">Home</a>
        <a href="/daivai/prossimi-eventi" class="menu-link">Prossimi eventi</a>
    </nav>
</div>

<script>
    import { supabase } from "../../lib/supabase";
    import { gsap } from "gsap";

    // Login Modal Toggle
    const loginModal = document.getElementById("login-modal") as HTMLDivElement;
    const closeLogin = document.getElementById(
        "close-login",
    ) as HTMLButtonElement;
    const profileLink = document.getElementById(
        "profile-link",
    ) as HTMLAnchorElement;

    async function toggleLoginModal(show: boolean) {
        if (!loginModal || !profileLink) return;

        // Calculate button center for the radial expansion
        const rect = profileLink.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (show) {
            // Calculate radius to cover the entire screen
            const radius = Math.hypot(
                Math.max(centerX, window.innerWidth - centerX),
                Math.max(centerY, window.innerHeight - centerY),
            );

            gsap.set(loginModal, {
                display: "flex",
                opacity: 1,
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
            });

            gsap.to(loginModal, {
                clipPath: `circle(${radius}px at ${centerX}px ${centerY}px)`,
                duration: 0.6,
                ease: "expo.inOut",
            });

            gsap.from(".login-modal-content", {
                scale: 0.8,
                y: 20,
                opacity: 0,
                duration: 0.6,
                delay: 0.2,
                ease: "back.out(1.7)",
            });
            document.body.style.overflow = "hidden";
        } else {
            gsap.to(loginModal, {
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
                duration: 0.5,
                ease: "expo.inOut",
                onComplete: () => {
                    gsap.set(loginModal, { display: "none" });
                },
            });
            document.body.style.overflow = "";
        }
    }

    // Update profile link based on auth status
    async function updateProfileLink() {
        const {
            data: { user },
        } = await supabase.auth.getUser();

        if (user && profileLink) {
            profileLink.href = "/daivai/profile";
        } else {
            if (profileLink) {
                profileLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleLoginModal(true);
                });
            }
        }
    }

    updateProfileLink();

    // Close modal when clicking outside
    loginModal?.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (
            target === loginModal ||
            target.classList.contains("login-modal-content")
        ) {
            toggleLoginModal(false);
        }
    });

    // Hamburger Menu Toggle
    const menuToggle = document.getElementById(
        "menu-toggle",
    ) as HTMLButtonElement;
    const menuOverlay = document.getElementById(
        "menu-overlay",
    ) as HTMLDivElement;
    const menuLinks = document.querySelectorAll(".menu-link");
    const navMenuWrapper = document.querySelector(
        ".nav-menu-wrapper",
    ) as HTMLDivElement;
    const navAuthWrapper = document.querySelector(
        ".nav-auth-wrapper",
    ) as HTMLDivElement;

    let isMenuOpen = false;

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;

        // Kill existing animations to prevent race conditions
        gsap.killTweensOf([
            navMenuWrapper,
            navAuthWrapper,
            menuOverlay,
            menuLinks,
            ".menu-header",
        ]);

        // Calculate button center for the radial expansion
        const rect = menuToggle.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (isMenuOpen) {
            // Calculate radius to cover the entire screen
            const radius = Math.hypot(
                Math.max(centerX, window.innerWidth - centerX),
                Math.max(centerY, window.innerHeight - centerY),
            );

            // Hide navbar buttons
            gsap.to([navMenuWrapper, navAuthWrapper], {
                opacity: 0,
                duration: 0.3,
                pointerEvents: "none",
                overwrite: true,
            });

            // Show overlay with circle expansion
            gsap.set(menuOverlay, {
                display: "flex",
                opacity: 1,
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
            });

            gsap.to(menuOverlay, {
                clipPath: `circle(${radius}px at ${centerX}px ${centerY}px)`,
                duration: 0.5,
                ease: "expo.inOut",
                overwrite: true,
            });

            // Logo and links staggered entrance
            gsap.to([".menu-header", ...menuLinks], {
                opacity: 1,
                duration: 0.6,
                stagger: 0.08,
                ease: "power2.out",
                delay: 0.2, // Start appearing as the circle expands
                overwrite: true,
            });

            // Prevent scrolling
            document.body.style.overflow = "hidden";
        } else {
            // Show navbar buttons
            gsap.to([navMenuWrapper, navAuthWrapper], {
                opacity: 1,
                duration: 0.2,
                pointerEvents: "auto",
                overwrite: true,
                delay: 0.25, // Wait for the circle to shrink a bit
            });

            // Hide overlay by shrinking the circle
            gsap.to(menuOverlay, {
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
                duration: 0.4,
                ease: "expo.inOut",
                overwrite: true,
                onComplete: () => {
                    if (!isMenuOpen) {
                        gsap.set(menuOverlay, { display: "none" });
                        // Reset opacity for next opening
                        gsap.set([".menu-header", ...menuLinks], {
                            opacity: 0,
                        });
                    }
                },
            });

            // Fast fade out for elements
            gsap.to([".menu-header", ...menuLinks], {
                opacity: 0,
                duration: 0.2,
                overwrite: true,
            });

            // Restore scrolling
            document.body.style.overflow = "";
        }
    }

    if (menuToggle) {
        menuToggle.addEventListener("click", toggleMenu);
    }

    // Close menu when clicking on a link
    menuLinks.forEach((link) => {
        link.addEventListener("click", () => {
            if (isMenuOpen) {
                toggleMenu();
            }
        });
    });

    // Close menu when clicking outside
    if (menuOverlay) {
        menuOverlay.addEventListener("click", (e) => {
            if (e.target === menuOverlay) {
                toggleMenu();
            }
        });
    }
</script>

<style>
    .nav-menu-wrapper,
    .nav-auth-wrapper {
        position: fixed;
        top: 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 4px;
        background-color: var(--primary-color);
        border: none;
        border-radius: 40px;
        transition: all 0.3s ease;
    }

    .nav-menu-wrapper {
        left: 20px;
    }

    .nav-auth-wrapper {
        right: 20px;
    }

    .nav-menu-wrapper:hover,
    .nav-auth-wrapper:hover {
        /* background-color: var(--secondary-color); - REMOVED */
    }

    .profile-btn,
    .menu-toggle {
        background: transparent;
        color: var(--secondary-color);
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .profile-btn:hover,
    .menu-toggle:hover,
    .profile-btn:active,
    .menu-toggle:active,
    .profile-btn:focus,
    .menu-toggle:focus {
        transform: scale(1.1);
        color: var(--secondary-color);
        background: transparent;
        outline: none;
    }

    .nav-menu-wrapper:hover .menu-toggle,
    .nav-auth-wrapper:hover .profile-btn {
        /* color: var(--primary-color); - REMOVED */
    }

    .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: var(--primary-color);
        display: none;
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px;
        /* clip-path expansion handled by JS */
    }

    .login-modal-content {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 40px;
        width: 100%;
        max-width: 450px;
        position: relative;
        box-shadow: none;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #fb6068;
        display: none;
        z-index: 999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
        /* Initial clip-path for expansion */
        clip-path: circle(0% at top left);
    }

    .menu-header {
        position: absolute;
        top: 120px;
        width: 100%;
        display: flex;
        justify-content: center;
        opacity: 0;
    }

    .menu-logo {
        width: 120px;
        height: auto;
    }

    .menu-nav {
        display: flex;
        flex-direction: column;
        gap: 3.5rem;
        align-items: center;
        margin-top: 120px;
    }

    .menu-link {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: clamp(1.4rem, 6vw, 2.6rem);
        letter-spacing: 0.05em;
        color: var(--secondary-color);
        text-decoration: none;
        text-transform: none;
        transition:
            transform 0.3s ease,
            text-shadow 0.3s ease;
        position: relative;
        opacity: 0;
    }

    .menu-link:hover {
        transform: scale(1.1);
        text-shadow: 0 0 20px rgba(245, 229, 144, 0.5);
    }

    @media (max-width: 768px) {
        .menu-nav {
            gap: 2.5rem;
        }

        .login-modal-content {
            padding: 30px 20px;
        }
    }
</style>
