---
import Auth from "@/components/features/Auth.astro";
---

<div class="nav-menu-wrapper">
    <!-- Pulsante Hamburger Menu / Logo -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Menu">
        <div class="icon-container">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="hamburger-icon"
            >
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
            <img
                src="/daivai/images/DaiVai-yellow.svg"
                alt="Logo"
                class="menu-logo-toggle"
                style="display: none; opacity: 0;"
            />
        </div>
    </button>
</div>

<div class="nav-auth-wrapper">
    <a
        href="#"
        id="profile-link"
        class="profile-btn"
        aria-label="Area Personale"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
    </a>
</div>

<!-- Login Modal -->
<div id="login-modal" class="login-modal">
    <div class="login-modal-content">
        <Auth />
    </div>
</div>

<!-- Backdrop trasparente per chiudere il menù cliccando fuori -->
<div id="menu-backdrop" class="menu-backdrop" style="display: none;"></div>

<!-- Menu Overlay Radiale -->
<div id="menu-overlay" class="menu-overlay">
    <div class="radial-menu-container">
        <!-- Ring 1 (Outer) - Prossimi Eventi -->
        <div class="menu-ring ring-1">
            <svg viewBox="0 0 1000 1000">
                <path
                    id="path-ring-1"
                    d="M 500, 500 m -380, 0 a 380,380 0 1,0 760,0 a 380,380 0 1,0 -760,0"
                    fill="transparent"
                    style="pointer-events: none;"></path>
                <a href="/daivai/prossimi-eventi" class="menu-link">
                    <text class="menu-item-text">
                        <textPath
                            href="#path-ring-1"
                            class="menu-text-path"
                            data-href="/daivai/prossimi-eventi"
                            textLength="2387"
                            lengthAdjust="spacing"
                            >PROSSIMI EVENTI&#160;•&#160;PROSSIMI
                            EVENTI&#160;•&#160;PROSSIMI
                            EVENTI&#160;•&#160;PROSSIMI EVENTI&#160;•&#160;</textPath
                        >
                    </text>
                </a>
            </svg>
        </div>

        <!-- Ring 2 (Middle) - Cosa Siamo -->
        <div class="menu-ring ring-2">
            <svg viewBox="0 0 1000 1000">
                <path
                    id="path-ring-2"
                    d="M 500, 500 m -270, 0 a 270,270 0 1,0 540,0 a 270,270 0 1,0 -540,0"
                    fill="transparent"
                    style="pointer-events: none;"></path>
                <a href="/daivai/cosa-siamo" class="menu-link">
                    <text class="menu-item-text">
                        <textPath
                            href="#path-ring-2"
                            class="menu-text-path"
                            data-href="/daivai/cosa-siamo"
                            textLength="1696"
                            lengthAdjust="spacing"
                            >COSA SIAMO&#160;•&#160;COSA SIAMO&#160;•&#160;COSA
                            SIAMO&#160;•&#160;COSA SIAMO&#160;•&#160;</textPath
                        >
                    </text>
                </a>
            </svg>
        </div>

        <!-- Ring 3 (Inner) - Home -->
        <div class="menu-ring ring-3">
            <svg viewBox="0 0 1000 1000">
                <path
                    id="path-ring-3"
                    d="M 500, 500 m -160, 0 a 160,160 0 1,0 320,0 a 160,160 0 1,0 -320,0"
                    fill="transparent"
                    style="pointer-events: none;"></path>
                <a href="/daivai/" class="menu-link">
                    <text class="menu-item-text">
                        <textPath
                            href="#path-ring-3"
                            class="menu-text-path"
                            data-href="/daivai/"
                            textLength="1005"
                            lengthAdjust="spacing"
                            >HOME&#160;•&#160;HOME&#160;•&#160;HOME&#160;•&#160;HOME&#160;•&#160;</textPath
                        >
                    </text>
                </a>
            </svg>
        </div>
    </div>
</div>

<script>
    import { supabase } from "@/lib/supabase";
    import { gsap } from "gsap";

    // Login Modal Toggle
    const loginModal = document.getElementById("login-modal") as HTMLDivElement;
    const closeLogin = document.getElementById(
        "close-login",
    ) as HTMLButtonElement;
    const profileLink = document.getElementById(
        "profile-link",
    ) as HTMLAnchorElement;

    async function toggleLoginModal(show: boolean) {
        if (!loginModal || !profileLink) return;

        // Calculate button center for the radial expansion
        const rect = profileLink.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (show) {
            // Calculate radius to cover the entire screen
            const radius = Math.hypot(
                Math.max(centerX, window.innerWidth - centerX),
                Math.max(centerY, window.innerHeight - centerY),
            );

            gsap.set(loginModal, {
                display: "flex",
                opacity: 1,
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
            });

            gsap.to(loginModal, {
                clipPath: `circle(${radius}px at ${centerX}px ${centerY}px)`,
                duration: 0.6,
                ease: "expo.inOut",
            });

            gsap.from(".login-modal-content", {
                scale: 0.8,
                y: 20,
                opacity: 0,
                duration: 0.6,
                delay: 0.2,
                ease: "back.out(1.7)",
            });
            document.body.style.overflow = "hidden";
        } else {
            gsap.to(loginModal, {
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
                duration: 0.5,
                ease: "expo.inOut",
                onComplete: () => {
                    gsap.set(loginModal, { display: "none" });
                },
            });
            document.body.style.overflow = "";
        }
    }

    // Update profile link based on auth status
    async function updateProfileLink() {
        const {
            data: { user },
        } = await supabase.auth.getUser();

        if (user && profileLink) {
            profileLink.href = "/daivai/profile";
        } else {
            if (profileLink) {
                profileLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleLoginModal(true);
                });
            }
        }
    }

    updateProfileLink();

    // Close modal when clicking outside
    loginModal?.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (
            target === loginModal ||
            target.classList.contains("login-modal-content")
        ) {
            toggleLoginModal(false);
        }
    });

    // Hamburger Menu Toggle Radiale
    const menuToggle = document.getElementById(
        "menu-toggle",
    ) as HTMLButtonElement;
    const menuOverlay = document.getElementById(
        "menu-overlay",
    ) as HTMLDivElement;
    const navMenuWrapper = document.querySelector(
        ".nav-menu-wrapper",
    ) as HTMLDivElement;
    const navAuthWrapper = document.querySelector(
        ".nav-auth-wrapper",
    ) as HTMLDivElement;
    const hamburgerIcon = document.querySelector(
        ".hamburger-icon",
    ) as SVGElement;
    const menuLogoToggle = document.querySelector(
        ".menu-logo-toggle",
    ) as HTMLImageElement;
    const rings = document.querySelectorAll(".menu-ring");
    const menuBackdrop = document.getElementById(
        "menu-backdrop",
    ) as HTMLDivElement;
    let isMenuOpen = false;
    let rotationTimelines: gsap.core.Timeline[] = [];

    // Testo radiale pre-calcolato magicamente nell'HTML (3 ripetizioni perfette)

    // Colleghiamo PRIMA il pulsante hamburger per evitare che errori lo blocchino
    if (menuToggle) {
        menuToggle.addEventListener("click", toggleMenu);
    }

    function initRingRotations() {
        rings.forEach((ring, i) => {
            const tl = gsap.timeline({ repeat: -1 });
            const direction = i % 2 === 0 ? 360 : -360;
            tl.to(ring, {
                rotation: direction,
                duration: 40 + i * 10,
                ease: "none",
                transformOrigin: "center center",
                svgOrigin: "500 500", // Ensure rotation around the SVG center
            });
            rotationTimelines.push(tl);
        });
    }

    initRingRotations();

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;

        const rect = menuToggle.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (isMenuOpen) {
            // Posizionamento dinamico del centro del menu basato sul pulsante
            gsap.set(".radial-menu-container", {
                left: centerX,
                top: centerY,
            });

            // Expansion radius: covers only the menu area
            // Raggio enorme per coprire TUTTO lo schermo (non solo 42%)
            const radius = Math.max(window.innerWidth, window.innerHeight) * 2;

            // 0. Show backdrop
            gsap.set(menuBackdrop, { display: "block" });

            // 1. Icon Transformation
            gsap.to(hamburgerIcon, {
                opacity: 0,
                scale: 0.5,
                duration: 0.3,
                onComplete: () => {
                    gsap.set(hamburgerIcon, { display: "none" });
                },
            });
            gsap.set(menuLogoToggle, { display: "block" });
            gsap.to(menuLogoToggle, {
                opacity: 1,
                scale: 2.5, // Si ingrandisce molto all'apertura
                rotation: -45,
                duration: 0.5,
                ease: "back.out(1.7)",
                delay: 0.1,
            });

            // 2. Radial Expansion
            gsap.set(menuOverlay, {
                display: "block",
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
            });

            gsap.to(menuOverlay, {
                clipPath: `circle(${radius}px at ${centerX}px ${centerY}px)`,
                duration: 0.8,
                ease: "expo.inOut",
                onComplete: () => {
                    // Rimuoviamo il clipPath per non interferire con il rendering o gli eventi
                    gsap.set(menuOverlay, { clipPath: "none" });

                    // IMPORTANTE: L'overlay deve restare 'auto' per catturare i click di chiusura,
                    // ma i figli hanno la priorità se hanno pointer-events: auto.
                    gsap.set(menuOverlay, { pointerEvents: "auto" });
                },
            });

            // 3. Rings Entrance
            gsap.fromTo(
                rings,
                { scale: 0, opacity: 0 },
                {
                    scale: 1,
                    opacity: 1,
                    duration: 1,
                    stagger: 0.1,
                    ease: "back.out(1.2)",
                    delay: 0.2,
                },
            );

            // Start rotations
            rotationTimelines.forEach((tl) => tl.play());

            document.body.style.overflow = "hidden";
        } else {
            // 1. Icon Transformation Back
            gsap.to(menuLogoToggle, {
                opacity: 0,
                scale: 0.5, // Torna piccolo
                rotation: 0,
                duration: 0.3,
                onComplete: () => {
                    gsap.set(menuLogoToggle, { display: "none" });
                },
            });
            gsap.set(hamburgerIcon, { display: "block" });
            gsap.to(hamburgerIcon, {
                opacity: 1,
                scale: 1,
                duration: 0.4,
                delay: 0.1,
            });

            // 2. Close Overlay
            gsap.to(menuOverlay, {
                opacity: 0, // Aggiungiamo un fade per sicurezza nell'uscita
                duration: 0.4,
                ease: "power2.inOut",
                onComplete: () => {
                    gsap.set(menuOverlay, { display: "none", opacity: 1 });
                    rotationTimelines.forEach((tl) => tl.pause());
                },
            });

            // Fade out rings
            gsap.to(rings, { opacity: 0, scale: 0.8, duration: 0.4 });

            // Hide backdrop
            gsap.set(menuBackdrop, { display: "none" });

            document.body.style.overflow = "";
        }
    }

    // Gestione click sul menu overlay (NAVIGAZIONE + CHIUSURA)
    if (menuOverlay) {
        menuOverlay.addEventListener("click", (e) => {
            if (!isMenuOpen) return;

            const target = e.target as HTMLElement;

            // 1. Cerchiamo se abbiamo cliccato un link del menu
            // Usiamo target e closest per identificare l'elemento SVG o il link
            const menuLink =
                target.closest(".menu-link") ||
                target.closest(".menu-text-path");

            if (menuLink) {
                const href =
                    menuLink.getAttribute("href") ||
                    menuLink.getAttribute("data-href");
                console.log("Navigating to:", href);
                if (href) {
                    window.location.href = href;
                    return;
                }
            }

            // 2. Fallback per mobile/touch: controlliamo elementi sotto il punto di pressione
            const x = (e as MouseEvent).clientX;
            const y = (e as MouseEvent).clientY;
            const elements = document.elementsFromPoint(x, y);
            const foundLink = elements.find(
                (el) =>
                    el.classList.contains("menu-text-path") ||
                    el.classList.contains("menu-link"),
            );

            if (foundLink) {
                const href =
                    foundLink.getAttribute("data-href") ||
                    foundLink.getAttribute("href");
                if (href) {
                    window.location.href = href;
                    return;
                }
            }

            // 3. Se non è un link, chiudiamo il menu
            console.log("Overlay clicked, but no link found. Closing.");
            toggleMenu();
        });
    }

    // Gestione click sul backdrop (CHIUSURA)
    if (menuBackdrop) {
        menuBackdrop.addEventListener("click", (e) => {
            e.stopPropagation();
            if (isMenuOpen) toggleMenu();
        });
    }
</script>

<style>
    .nav-menu-wrapper,
    .nav-auth-wrapper {
        position: fixed;
        top: 20px;
        z-index: 2000; /* Sopra l'overlay radiale */
        display: flex;
        align-items: center;
        padding: 4px;
        background-color: var(--primary-color);
        border: none;
        border-radius: 40px;
        transition: all 0.3s ease;
    }

    .nav-menu-wrapper {
        left: 20px;
    }

    .nav-auth-wrapper {
        right: 20px;
    }

    .icon-container {
        position: relative;
        width: 32px; /* Ripristinato dimensione standard */
        height: 32px; /* Ripristinato */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .menu-logo-toggle {
        width: 30px;
        height: auto;
        position: absolute;
        transform: rotate(-45deg);
        z-index: 2100; /* Assicura che sia sopra tutto durante l'espansione */
    }

    .profile-btn,
    .menu-toggle {
        background: transparent;
        color: var(--secondary-color);
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .menu-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: transparent;
        z-index: 1400; /* Sotto l'overlay radiale (1500) */
        pointer-events: auto;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #ce414e;
        display: none;
        z-index: 1500;
        overflow: hidden;
        pointer-events: auto; /* Base per l'apertura */
    }

    .radial-menu-container {
        position: absolute;
        top: 40px;
        left: 40px;
        width: 100vw;
        height: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        transform: translate(-50%, -50%);
    }

    .menu-ring {
        position: absolute;
        width: 100vw;
        height: 100vw;
        pointer-events: none; /* Non blocca il centro */
    }

    .menu-ring svg {
        width: 100%;
        height: 100%;
        overflow: visible;
        pointer-events: none; /* Cruciale: non deve bloccare il resto del menu */
    }

    .menu-link {
        pointer-events: auto !important;
        cursor: pointer !important;
    }

    .menu-text-path {
        font-family: var(--font-heading);
        font-weight: 800;
        font-size: 52px;
        text-transform: uppercase;
        letter-spacing: 0.02em; /* Spaziatura ridotta e naturale */
        transition: fill 0.3s ease;
        pointer-events: auto !important;
        cursor: pointer !important;
        fill: #f5e590;
    }

    .menu-text-path:hover {
        fill: #ffffff;
    }

    .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: var(--primary-color);
        display: none;
        z-index: 2500;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .login-modal-content {
        background: transparent;
        width: 100%;
        max-width: 450px;
        position: relative;
    }

    @media (max-width: 768px) {
        .menu-text-path {
            font-size: 50px;
        }

        .ring-1 {
            width: 200vw;
            height: 200vw;
        }
        .ring-2 {
            width: 150vw;
            height: 150vw;
        }
        .ring-3 {
            width: 100vw;
            height: 100vw;
        }

        .radial-menu-container {
            top: 40px;
            left: 40px;
        }
    }
</style>
