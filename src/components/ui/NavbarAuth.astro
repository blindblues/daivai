---
import Auth from "@/components/features/Auth.astro";
---

<div class="nav-auth-wrapper">
    <!-- Icona Profilo con Link Dinamico -->
    <a
        href="#"
        id="profile-link"
        class="profile-btn"
        aria-label="Area Personale"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle
                cx="12"
                cy="7"
                r="4"></circle></svg
        >
    </a>

    <!-- Pulsante Hamburger Menu -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Apri Menu">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="hamburger-icon"
        >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="close-icon"
            style="display: none;"
        >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<!-- Login Modal -->
<div id="login-modal" class="login-modal">
    <div class="login-modal-content">
        <button
            id="close-login"
            class="close-modal-btn"
            aria-label="Chiudi Login"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><line x1="18" y1="6" x2="6" y2="18"></line><line
                    x1="6"
                    y1="6"
                    x2="18"
                    y2="18"></line></svg
            >
        </button>
        <Auth />
    </div>
</div>

<!-- Menu Overlay -->
<div id="menu-overlay" class="menu-overlay">
    <div class="menu-header">
        <a href="/daivai/" aria-label="Home">
            <img
                src="/daivai/images/DaiVai-yellow.svg"
                alt="DaiVai Logo"
                class="menu-logo"
            />
        </a>
    </div>
    <nav class="menu-nav">
        <a href="/daivai/#cosa-siamo" class="menu-link">Cosa siamo</a>
        <a href="/daivai/#cosa-facciamo" class="menu-link">Cosa facciamo</a>
        <a href="/daivai/#come-funziona" class="menu-link">Come funziona</a>
        <a href="/daivai/#ultimi-eventi" class="menu-link">Eventi</a>
    </nav>
</div>

<script>
    import { supabase } from "../../lib/supabase";
    import { gsap } from "gsap";

    // Login Modal Toggle
    const loginModal = document.getElementById("login-modal") as HTMLDivElement;
    const closeLogin = document.getElementById(
        "close-login",
    ) as HTMLButtonElement;
    const profileLink = document.getElementById(
        "profile-link",
    ) as HTMLAnchorElement;

    async function toggleLoginModal(show: boolean) {
        if (show) {
            gsap.set(loginModal, { display: "flex" });
            gsap.to(loginModal, {
                opacity: 1,
                duration: 0.5,
                ease: "power2.out",
            });
            gsap.from(".login-modal-content", {
                scale: 0.8,
                y: 20,
                opacity: 0,
                duration: 0.6,
                ease: "back.out(1.7)",
            });
            document.body.style.overflow = "hidden";
        } else {
            gsap.to(loginModal, {
                opacity: 0,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    gsap.set(loginModal, { display: "none" });
                },
            });
            document.body.style.overflow = "";
        }
    }

    // Update profile link based on auth status
    async function updateProfileLink() {
        const {
            data: { user },
        } = await supabase.auth.getUser();

        if (user && profileLink) {
            profileLink.href = "/daivai/profile";
        } else {
            if (profileLink) {
                profileLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleLoginModal(true);
                });
            }
        }
    }

    updateProfileLink();

    if (closeLogin) {
        closeLogin.addEventListener("click", () => toggleLoginModal(false));
    }

    // Close modal when clicking outside
    loginModal?.addEventListener("click", (e) => {
        if (e.target === loginModal) {
            toggleLoginModal(false);
        }
    });

    // Hamburger Menu Toggle
    const menuToggle = document.getElementById(
        "menu-toggle",
    ) as HTMLButtonElement;
    const menuOverlay = document.getElementById(
        "menu-overlay",
    ) as HTMLDivElement;
    const menuLinks = document.querySelectorAll(".menu-link");
    const navAuthWrapper = document.querySelector(
        ".nav-auth-wrapper",
    ) as HTMLDivElement;

    let isMenuOpen = false;

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;

        // Kill existing animations to prevent race conditions
        gsap.killTweensOf([
            navAuthWrapper,
            menuOverlay,
            menuLinks,
            ".menu-header",
        ]);

        // Calculate button center for the radial expansion
        const rect = menuToggle.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (isMenuOpen) {
            // Calculate radius to cover the entire screen
            const radius = Math.hypot(
                Math.max(centerX, window.innerWidth - centerX),
                Math.max(centerY, window.innerHeight - centerY),
            );

            // Hide navbar buttons
            gsap.to(navAuthWrapper, {
                opacity: 0,
                duration: 0.3,
                pointerEvents: "none",
                overwrite: true,
            });

            // Show overlay with circle expansion
            gsap.set(menuOverlay, {
                display: "flex",
                opacity: 1,
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
            });

            gsap.to(menuOverlay, {
                clipPath: `circle(${radius}px at ${centerX}px ${centerY}px)`,
                duration: 0.5,
                ease: "expo.inOut",
                overwrite: true,
            });

            // Logo and links staggered entrance
            gsap.to([".menu-header", ...menuLinks], {
                opacity: 1,
                duration: 0.6,
                stagger: 0.08,
                ease: "power2.out",
                delay: 0.2, // Start appearing as the circle expands
                overwrite: true,
            });

            // Prevent scrolling
            document.body.style.overflow = "hidden";
        } else {
            // Show navbar buttons
            gsap.to(navAuthWrapper, {
                opacity: 1,
                duration: 0.2,
                pointerEvents: "auto",
                overwrite: true,
                delay: 0.25, // Wait for the circle to shrink a bit
            });

            // Hide overlay by shrinking the circle
            gsap.to(menuOverlay, {
                clipPath: `circle(0% at ${centerX}px ${centerY}px)`,
                duration: 0.4,
                ease: "expo.inOut",
                overwrite: true,
                onComplete: () => {
                    if (!isMenuOpen) {
                        gsap.set(menuOverlay, { display: "none" });
                        // Reset opacity for next opening
                        gsap.set([".menu-header", ...menuLinks], {
                            opacity: 0,
                        });
                    }
                },
            });

            // Fast fade out for elements
            gsap.to([".menu-header", ...menuLinks], {
                opacity: 0,
                duration: 0.2,
                overwrite: true,
            });

            // Restore scrolling
            document.body.style.overflow = "";
        }
    }

    if (menuToggle) {
        menuToggle.addEventListener("click", toggleMenu);
    }

    // Close menu when clicking on a link
    menuLinks.forEach((link) => {
        link.addEventListener("click", () => {
            if (isMenuOpen) {
                toggleMenu();
            }
        });
    });

    // Close menu when clicking outside
    if (menuOverlay) {
        menuOverlay.addEventListener("click", (e) => {
            if (e.target === menuOverlay) {
                toggleMenu();
            }
        });
    }
</script>

<style>
    .nav-auth-wrapper {
        position: fixed;
        top: 25px;
        right: 25px;
        z-index: 1000;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 4px;
        padding: 6px;
        background: rgba(var(--primary-rgb), 0.4);
        backdrop-filter: blur(12px) saturate(180%);
        -webkit-backdrop-filter: blur(12px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .profile-btn,
    .menu-toggle {
        background: transparent;
        color: var(--secondary-color);
        border: none;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .profile-btn:hover,
    .menu-toggle:hover {
        background: rgba(0, 0, 0, 0.05);
        transform: scale(1.05);
    }

    .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        display: none;
        opacity: 0;
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .login-modal-content {
        background: rgba(var(--primary-rgb), 0.4);
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        padding: 40px;
        width: 100%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .close-modal-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: color 0.3s ease;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-modal-btn:hover {
        color: white;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #fb6068;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: none;
        z-index: 999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
        /* Initial clip-path for expansion */
        clip-path: circle(0% at top right);
    }

    .menu-header {
        position: absolute;
        top: 120px;
        width: 100%;
        display: flex;
        justify-content: center;
        opacity: 0;
    }

    .menu-logo {
        width: 120px;
        height: auto;
    }

    .menu-nav {
        display: flex;
        flex-direction: column;
        gap: 3.5rem;
        align-items: center;
        margin-top: 120px;
    }

    .menu-link {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: clamp(1.4rem, 6vw, 2.6rem);
        letter-spacing: 0.05em;
        color: var(--secondary-color);
        text-decoration: none;
        text-transform: none;
        transition:
            transform 0.3s ease,
            text-shadow 0.3s ease;
        position: relative;
        opacity: 0;
    }

    .menu-link:hover {
        transform: scale(1.1);
        text-shadow: 0 0 20px rgba(245, 229, 144, 0.5);
    }

    @media (max-width: 768px) {
        .menu-nav {
            gap: 2.5rem;
        }

        .login-modal-content {
            padding: 30px 20px;
        }
    }
</style>
