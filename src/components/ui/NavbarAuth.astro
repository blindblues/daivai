---
import Auth from "@/components/features/Auth.astro";
---

<div class="nav-auth-wrapper">
    <!-- Icona Profilo con Link Dinamico -->
    <a
        href="#"
        id="profile-link"
        class="profile-btn"
        aria-label="Area Personale"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle
                cx="12"
                cy="7"
                r="4"></circle></svg
        >
    </a>

    <!-- Pulsante Hamburger Menu -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Apri Menu">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="hamburger-icon"
        >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="close-icon"
            style="display: none;"
        >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<!-- Login Modal -->
<div id="login-modal" class="login-modal">
    <div class="login-modal-content">
        <button
            id="close-login"
            class="close-modal-btn"
            aria-label="Chiudi Login"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><line x1="18" y1="6" x2="6" y2="18"></line><line
                    x1="6"
                    y1="6"
                    x2="18"
                    y2="18"></line></svg
            >
        </button>
        <Auth />
    </div>
</div>

<!-- Menu Overlay -->
<div id="menu-overlay" class="menu-overlay">
    <nav class="menu-nav">
        <a href="/daivai/" class="menu-link">HOME</a>
        <a href="/daivai/#cosa-siamo" class="menu-link">CHI SIAMO</a>
        <a href="/daivai/#cosa-facciamo" class="menu-link">COSA FACCIAMO</a>
        <a href="/daivai/#come-funziona" class="menu-link">COME FUNZIONA</a>
        <a href="/daivai/#ultimi-eventi" class="menu-link">EVENTI</a>
        <a href="/daivai/profile" id="menu-profile-link" class="menu-link"
            >IL MIO PROFILO</a
        >
    </nav>
</div>

<script>
    import { supabase } from "../../lib/supabase";
    import { gsap } from "gsap";

    // Login Modal Toggle
    const loginModal = document.getElementById("login-modal") as HTMLDivElement;
    const closeLogin = document.getElementById(
        "close-login",
    ) as HTMLButtonElement;
    const profileLink = document.getElementById(
        "profile-link",
    ) as HTMLAnchorElement;

    async function toggleLoginModal(show: boolean) {
        if (show) {
            gsap.set(loginModal, { display: "flex" });
            gsap.to(loginModal, {
                opacity: 1,
                duration: 0.5,
                ease: "power2.out",
            });
            gsap.from(".login-modal-content", {
                scale: 0.8,
                y: 20,
                opacity: 0,
                duration: 0.6,
                ease: "back.out(1.7)",
            });
            document.body.style.overflow = "hidden";
        } else {
            gsap.to(loginModal, {
                opacity: 0,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    gsap.set(loginModal, { display: "none" });
                },
            });
            document.body.style.overflow = "";
        }
    }

    // Update profile link based on auth status
    async function updateProfileLink() {
        const {
            data: { user },
        } = await supabase.auth.getUser();

        const menuProfileLink = document.getElementById(
            "menu-profile-link",
        ) as HTMLAnchorElement;

        if (user && profileLink) {
            profileLink.href = "/daivai/profile";
            if (menuProfileLink) {
                menuProfileLink.href = "/daivai/profile";
            }
        } else {
            if (profileLink) {
                profileLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleLoginModal(true);
                });
            }
            if (menuProfileLink) {
                menuProfileLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleMenu(); // Close hamburger
                    toggleLoginModal(true);
                });
            }
        }
    }

    updateProfileLink();

    if (closeLogin) {
        closeLogin.addEventListener("click", () => toggleLoginModal(false));
    }

    // Close modal when clicking outside
    loginModal?.addEventListener("click", (e) => {
        if (e.target === loginModal) {
            toggleLoginModal(false);
        }
    });

    // Hamburger Menu Toggle
    const menuToggle = document.getElementById(
        "menu-toggle",
    ) as HTMLButtonElement;
    const menuOverlay = document.getElementById(
        "menu-overlay",
    ) as HTMLDivElement;
    const menuLinks = document.querySelectorAll(".menu-link");
    const hamburgerIcon = document.querySelector(
        ".hamburger-icon",
    ) as SVGElement;
    const closeIcon = document.querySelector(".close-icon") as SVGElement;

    let isMenuOpen = false;

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;

        if (isMenuOpen) {
            // Show overlay
            gsap.set(menuOverlay, { display: "flex" });
            gsap.to(menuOverlay, {
                opacity: 1,
                duration: 0.4,
                ease: "power2.out",
            });

            // Stagger animation for links
            gsap.fromTo(
                menuLinks,
                { y: 50, opacity: 0 },
                {
                    y: 0,
                    opacity: 1,
                    duration: 0.6,
                    stagger: 0.1,
                    ease: "back.out(1.2)",
                },
            );

            // Toggle icons
            hamburgerIcon.style.display = "none";
            closeIcon.style.display = "block";

            // Prevent scrolling
            document.body.style.overflow = "hidden";
        } else {
            // Hide overlay
            gsap.to(menuOverlay, {
                opacity: 0,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    gsap.set(menuOverlay, { display: "none" });
                },
            });

            // Toggle icons
            hamburgerIcon.style.display = "block";
            closeIcon.style.display = "none";

            // Restore scrolling
            document.body.style.overflow = "";
        }
    }

    if (menuToggle) {
        menuToggle.addEventListener("click", toggleMenu);
    }

    // Close menu when clicking on a link
    menuLinks.forEach((link) => {
        link.addEventListener("click", () => {
            if (isMenuOpen) {
                toggleMenu();
            }
        });
    });

    // Close menu when clicking outside
    if (menuOverlay) {
        menuOverlay.addEventListener("click", (e) => {
            if (e.target === menuOverlay) {
                toggleMenu();
            }
        });
    }
</script>

<style>
    .nav-auth-wrapper {
        position: fixed;
        top: 25px;
        right: 25px;
        z-index: 1000;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 4px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px) saturate(180%);
        -webkit-backdrop-filter: blur(12px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .profile-btn,
    .menu-toggle {
        background: transparent;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .profile-btn:hover,
    .menu-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.05);
    }

    .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        display: none;
        opacity: 0;
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .login-modal-content {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        padding: 40px;
        width: 100%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .close-modal-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: color 0.3s ease;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-modal-btn:hover {
        color: white;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(
            135deg,
            rgba(251, 96, 104, 0.95) 0%,
            rgba(245, 229, 144, 0.95) 100%
        );
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: none;
        opacity: 0;
        z-index: 999;
        justify-content: center;
        align-items: center;
    }

    .menu-nav {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
    }

    .menu-link {
        font-family: var(--font-heading);
        font-size: clamp(2rem, 8vw, 4rem);
        color: white;
        text-decoration: none;
        text-transform: uppercase;
        transition: all 0.3s ease;
        position: relative;
    }

    .menu-link::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 0;
        height: 3px;
        background: white;
        transition: width 0.3s ease;
    }

    .menu-link:hover {
        transform: scale(1.1);
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .menu-link:hover::after {
        width: 100%;
    }

    @media (max-width: 768px) {
        .menu-link {
            font-size: clamp(1.5rem, 10vw, 3rem);
        }

        .menu-nav {
            gap: 1.5rem;
        }

        .login-modal-content {
            padding: 30px 20px;
        }
    }
</style>
